<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villain Simulator Config Editor v2.0</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #3498db;
            --secondary-color: #2ecc71;
            --border-color: #444;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 250px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #aaa;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .nav-btn:hover {
            background: #3a3a3a;
            color: #fff;
        }

        .nav-btn.active {
            background: var(--accent-color);
            color: #fff;
        }

        .nav-header {
            font-weight: bold;
            color: #666;
            font-size: 0.8em;
            margin: 15px 0 5px 0;
            text-transform: uppercase;
        }

        /* --- Main Area --- */
        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.9em;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            color: #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .list-item {
            background: #333;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .list-item:hover {
            background: #444;
        }

        .list-item.selected {
            border-left: 3px solid var(--accent-color);
            background: #383838;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* --- JSON View --- */
        #json-area {
            height: 150px;
            background: #111;
            color: #2ecc71;
            font-family: monospace;
            padding: 10px;
            overflow: auto;
            border-top: 1px solid var(--border-color);
        }

        /* --- Timeline View Specifics --- */
        .timeline-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #222;
        }

        .timeline-header {
            padding: 10px;
            background: #333;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .timeline-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .node-item {
            padding: 8px;
            background: #2a2a2a;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .node-item:hover {
            background: #3a3a3a;
        }

        .node-item.selected {
            border-color: var(--accent-color);
            background: #383838;
        }

        .node-key {
            border-left-color: var(--accent-color);
        }

        /* Blue for key nodes */
        .node-pool {
            border-left-color: var(--secondary-color);
        }

        /* Green for pools */
    </style>
</head>

<body>

    <div id="sidebar">
        <h2 style="margin:0 0 20px 0; color:var(--accent-color);">é…ç½®ç¼–è¾‘å™¨ (Config Editor)</h2>

        <button id="btn-worlds" class="nav-btn active" onclick="app.nav('worlds')">ä¸–ç•Œ</button>
        <button id="btn-talents" class="nav-btn" onclick="app.nav('talents')">å¤©èµ‹</button>
        <button id="btn-events" class="nav-btn" onclick="app.nav('events')">äº‹ä»¶</button>
        <button id="btn-endings" class="nav-btn" onclick="app.nav('endings')">ç»“ç®—</button>
        <button id="btn-timeline" class="nav-btn" onclick="app.nav('timeline')">æ—¶é—´è½´</button>

        <div class="nav-header">å·¥å…·</div>
        <button id="btn-appearance" class="nav-btn" onclick="app.nav('appearance')">ğŸ¨ å¤–è§‚è®¾ç½®</button>
        <button id="btn-export" class="nav-btn" onclick="app.nav('export')">å¯¼å…¥ / å¯¼å‡º</button>
    </div>

    <div style="display:flex; flex-direction:column; flex-grow:1;">
        <div id="main">
            <!-- Content injected here -->
        </div>
        <div id="json-area">
            <!-- Live JSON preview -->
        </div>
    </div>

    <script>
        const app = {
            data: {
                // Initial real data from Engine v1.0
                initialPoints: 20,

                // Theme / Appearance
                theme: {
                    title: 'åæ´¾æ¨¡æ‹Ÿå™¨',
                    subtitle: 'Core Engine v1.0',
                    bgColor: '#121212',
                    textColor: '#e0e0e0',
                    accentColor: '#bb86fc',
                    secondaryColor: '#03dac6',
                    panelBg: '#1e1e1e',
                    borderColor: '#333'
                },

                worlds: [
                    {
                        id: "w_fantasy",
                        name: "æµ‹è¯•ä¸–ç•Œï¼šä¿®ä»™",
                        desc: "è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å±æ€§æ˜ å°„çš„ä¿®ä»™ä¸–ç•Œæ¨¡ç‰ˆã€‚",
                        uniqueAttributes: ["ä¿®ä¸º", "æ ¹éª¨", "é­”å¿µ", "å¯¿å…ƒ"]
                    },
                    {
                        id: "w_city",
                        name: "æµ‹è¯•ä¸–ç•Œï¼šéƒ½å¸‚",
                        desc: "è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„ç°ä»£éƒ½å¸‚æ¨¡ç‰ˆã€‚",
                        uniqueAttributes: ["æ™ºå•†", "ä½“é­„", "é‡‘é’±", "äººè„‰"]
                    }
                ],
                endings: [],

                talents: [
                    { id: "t_f_1", worldId: "w_fantasy", name: "å¤©ç”Ÿé­”ç§", desc: "é­”å¿µ+5", effect: { "é­”å¿µ": 5 } },
                    { id: "t_f_2", worldId: "w_fantasy", name: "é•¿ç”Ÿè¯€", desc: "å¯¿å…ƒ+50", effect: { "å¯¿å…ƒ": 50 } },
                    { id: "t_f_3", worldId: "w_fantasy", name: "åºŸæŸ´", desc: "æ ¹éª¨-2", effect: { "æ ¹éª¨": -2 } },
                    { id: "t_f_4", worldId: "w_fantasy", name: "é˜µæ³•å¸ˆ", desc: "æ™ºåŠ›è½¬åŒ–ä¿®ä¸º", effect: { "ä¿®ä¸º": 2 } },
                    { id: "t_c_1", worldId: "w_city", name: "å¯ŒäºŒä»£", desc: "é‡‘é’±+10", effect: { "é‡‘é’±": 10 } },
                    { id: "t_c_2", worldId: "w_city", name: "é»‘å®¢", desc: "æ™ºå•†+5", effect: { "æ™ºå•†": 5 } }
                ],

                events: [
                    {
                        id: "e_born",
                        worldId: "w_fantasy", minAge: 0, maxAge: 0,
                        text: "ä½ å‡ºç”Ÿäº†ã€‚å‘¨å›´é­”æ°”ç¼­ç»•ã€‚",
                        effect: { "é­”å¿µ": 1 }
                    },
                    {
                        id: "e_cultivate",
                        worldId: "w_fantasy", minAge: 5, maxAge: 100,
                        text: "ä½ é—­å…³ä¿®ç‚¼ï¼Œä¿®ä¸ºç²¾è¿›ã€‚",
                        effect: { "ä¿®ä¸º": 1 }
                    },
                    {
                        id: "e_choice_test",
                        worldId: "w_fantasy", minAge: 10, maxAge: 20,
                        text: "ã€æµ‹è¯•ã€‘ä½ å‘ç°äº†ä¸€æœ¬é­”é“ç§˜ç±ã€‚",
                        choices: [
                            { text: "ä¿®ç‚¼ (é­”å¿µ+5)", effect: { "é­”å¿µ": 5 } },
                            { text: "é”€æ¯ (æ— äº‹å‘ç”Ÿ)", effect: {} }
                        ],
                        once: true
                    },
                    {
                        id: "e_city_born",
                        worldId: "w_city", minAge: 0, maxAge: 0,
                        text: "ä½ å‡ºç”Ÿåœ¨ä¸­å¿ƒåŒ»é™¢ã€‚çˆ¶äº²çœ‹ç€è´¦å•çš±çœ‰ã€‚",
                        effect: { "é‡‘é’±": -1 }
                    },
                    {
                        id: "e_city_work",
                        worldId: "w_city", minAge: 18, maxAge: 60,
                        text: "åˆæ˜¯996çš„ä¸€å¹´ã€‚",
                        effect: { "é‡‘é’±": 1, "ä½“é­„": -1 }
                    }
                ]
            },
            currentView: 'worlds',
            tempEndingRules: {},
            selectedId: null,
            selectedId: null,

            // Timeline State
            tlWorldId: null,
            tlFilter: null, // { minAge, maxAge, type }

            init() {
                if (this.data.worlds.length === 0) {
                    this.data.worlds.push({ id: 'w_demo', name: 'ç¤ºä¾‹ä¸–ç•Œ', desc: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä¸–ç•Œ', uniqueAttributes: ['å±æ€±1'] });
                }
                this.render();
            },

            nav(view) {
                this.currentView = view;
                this.selectedId = null;

                // Update Nav UI
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                const btnId = `btn-${view}`;
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.add('active');

                this.render();
            },

            render() {
                const main = document.getElementById('main');
                main.innerHTML = '';

                // Update JSON View
                document.getElementById('json-area').innerText = JSON.stringify(this.data, null, 2);

                if (this.currentView === 'export') {
                    this.renderExport(main);
                } else if (this.currentView === 'timeline') {
                    this.renderTimeline(main);
                } else if (this.currentView === 'appearance') {
                    this.renderAppearance(main);
                } else {
                    // Standard Views
                    let list = this.getList(this.currentView);
                    let renderer = this.getRenderer(this.currentView);

                    if (this.currentView === 'events') {
                        this.renderEventList(main, list, renderer);
                    } else if (this.currentView === 'talents') {
                        this.renderTalentList(main, list, renderer);
                    } else if (this.currentView === 'endings') {
                        this.renderEndingList(main, list, renderer);
                    } else {
                        this.renderList(main, list, renderer);
                    }
                }
            },

            getRenderer(view) {
                if (view === 'worlds') return this.renderWorldForm;
                if (view === 'talents') return this.renderTalentForm;
                if (view === 'talents') return this.renderTalentForm;
                if (view === 'events') return this.renderEventForm;
                if (view === 'endings') return this.renderEndingForm;
                return null;
            },

            // --- Timeline Renderer ---
            renderTimeline(container) {
                // 1. World Selector
                const header = document.createElement('div');
                header.style.marginBottom = '15px';
                header.innerHTML = `
            <label>é€‰æ‹©ä¸–ç•Œä»¥ç¼–è¾‘æ—¶é—´è½´ (Select World):</label>
            <select id="tl-world-select" onchange="app.setTlWorld(this.value)">
                <option value="">-- è¯·é€‰æ‹©ä¸–ç•Œ --</option>
                ${this.data.worlds.map(w => `<option value="${w.id}" ${w.id === this.tlWorldId ? 'selected' : ''}>${w.name}</option>`).join('')}
            </select>
        `;
                container.appendChild(header);

                if (!this.tlWorldId) return;

                // 2. Timeline Layout (3 Columns: Node List | Event Pool | Event Editor)
                const layout = document.createElement('div');
                layout.style.display = 'flex';
                layout.style.gap = '15px';
                layout.style.height = '100%';
                layout.style.overflow = 'hidden';

                // Col 1: Nodes (Age Filters) & Custom Node Creator
                const colNodes = document.createElement('div');
                colNodes.className = 'timeline-col';
                colNodes.innerHTML = `<div class="timeline-header">Timeline Controls</div>`;

                // Custom Node Creator Form
                const controlPanel = document.createElement('div');
                controlPanel.style.padding = '10px';
                controlPanel.style.background = '#2a2a2a';
                controlPanel.style.borderBottom = '1px solid #444';

                // Get world attributes
                const world = this.data.worlds.find(w => w.id === this.tlWorldId);
                const attrs = world ? world.uniqueAttributes : [];

                controlPanel.innerHTML = `
                    <div style="font-size:0.9em; font-weight:bold; margin-bottom:5px; color:var(--accent-color);">å¿«é€Ÿåˆ›å»ºèŠ‚ç‚¹ (Quick Node)</div>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="number" id="quick-age" placeholder="å¹´é¾„" style="width:50px;" value="0">
                        <select id="quick-attr" style="flex:1;">
                            <option value="">- æ•ˆæœ -</option>
                            ${attrs.map(a => `<option value="${a}">${a}</option>`).join('')}
                            <option value="å¯¿å…ƒ">å¯¿å…ƒ</option>
                            <option value="é‡‘é’±">é‡‘é’±</option>
                        </select>
                        <input type="number" id="quick-val" placeholder="æ•°å€¼" style="width:50px;">
                    </div>
                    <textarea id="quick-text" rows="2" placeholder="äº‹ä»¶æè¿°..." style="width:100%; margin-bottom:5px;"></textarea>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.addCustomNode()">+ åˆ›å»ºèŠ‚ç‚¹äº‹ä»¶</button>
                    <hr style="border-color:#444; margin:10px 0;">
                    <div style="font-size:0.9em; font-weight:bold; margin-bottom:5px; color:var(--secondary-color);">è¿‡æ»¤å™¨ (Filters)</div>
                    <button class="btn" style="width:100%; background:#444; color:#ccc;" onclick="app.addPool()">+ è¿‡æ»¤èŒƒå›´ (Pool)</button>
                `;
                colNodes.appendChild(controlPanel);

                const nodeList = document.createElement('div');
                nodeList.className = 'timeline-list';
                // ... (Node list rendering logic) ...


                // Render Existing Nodes/Pools based on actual events
                // Logic: Group existing events by min/max age
                const groups = {};
                this.data.events.filter(e => e.worldId === this.tlWorldId).forEach(e => {
                    const key = `${e.minAge}-${e.maxAge}`;
                    if (!groups[key]) groups[key] = { min: e.minAge, max: e.maxAge, events: [] };
                    groups[key].events.push(e);
                });

                // Sort groups
                const sortedKeys = Object.keys(groups).sort((a, b) => groups[a].min - groups[b].min);

                // Render Group Items
                sortedKeys.forEach(key => {
                    const g = groups[key];
                    const isKeyNode = g.min === g.max;
                    const div = document.createElement('div');
                    div.className = `node-item ${isKeyNode ? 'node-key' : 'node-pool'} ${this.tlFilter && this.tlFilter.key === key ? 'selected' : ''}`;
                    div.innerHTML = `
                <div style="font-weight:bold;">${isKeyNode ? `${g.min} å²` : `${g.min}-${g.max} å²`}</div>
                <div style="font-size:0.8em; color:#888;">${g.events.length} ä¸ªäº‹ä»¶</div>
            `;
                    div.onclick = () => {
                        this.tlFilter = { min: g.min, max: g.max, key: key };
                        this.selectedId = null; // Clear event selection
                        this.render();
                    };
                    nodeList.appendChild(div);
                });
                colNodes.appendChild(nodeList);

                // Col 2: Event List (Filtered by selected Node)
                const colEvents = document.createElement('div');
                colEvents.className = 'timeline-col';
                colEvents.innerHTML = `<div class="timeline-header">å·²é€‰äº‹ä»¶åˆ—è¡¨ (Events)</div>`;
                const eventList = document.createElement('div');
                eventList.className = 'timeline-list';

                if (this.tlFilter) {
                    // Filter events
                    const filtered = this.data.events.filter(e =>
                        e.worldId === this.tlWorldId &&
                        e.minAge === this.tlFilter.min &&
                        e.maxAge === this.tlFilter.max
                    );

                    // Add Event Button
                    const addEvtBtn = document.createElement('button');
                    addEvtBtn.className = 'btn btn-success';
                    addEvtBtn.style.width = '100%';
                    addEvtBtn.style.marginBottom = '10px';
                    addEvtBtn.innerText = '+ åœ¨æ­¤æ·»åŠ äº‹ä»¶';
                    addEvtBtn.onclick = () => {
                        const newEvt = {
                            id: Date.now().toString(),
                            worldId: this.tlWorldId,
                            minAge: this.tlFilter.min,
                            maxAge: this.tlFilter.max,
                            text: 'æ–°äº‹ä»¶'
                        };
                        this.data.events.push(newEvt);
                        this.selectedId = newEvt.id;
                        this.render();
                    };
                    eventList.appendChild(addEvtBtn);

                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `list-item ${item.id === this.selectedId ? 'selected' : ''}`;
                        let title = item.text ? item.text.substring(0, 20) + '...' : 'æœªå‘½å';
                        div.innerHTML = `<span>${title}</span>`;
                        div.onclick = () => {
                            this.selectedId = item.id;
                            this.render();
                        };
                        // Delete btn
                        const delBtn = document.createElement('button');
                        delBtn.innerText = 'x';
                        delBtn.className = 'btn btn-danger';
                        delBtn.style.padding = '2px 6px';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®è®¤åˆ é™¤?')) {
                                const idx = this.data.events.findIndex(x => x.id === item.id);
                                this.data.events.splice(idx, 1);
                                this.selectedId = null;
                                this.render();
                            }
                        };
                        div.appendChild(delBtn);
                        eventList.appendChild(div);
                    });
                } else {
                    eventList.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">è¯·åœ¨å·¦ä¾§é€‰æ‹©èŠ‚ç‚¹/æ± </div>';
                }
                colEvents.appendChild(eventList);

                // Col 3: Event Editor
                const colEditor = document.createElement('div');
                colEditor.className = 'timeline-col';
                colEditor.style.flex = 1.5; // Wider
                colEditor.innerHTML = `<div class="timeline-header">äº‹ä»¶ç¼–è¾‘å™¨ (Event Editor)</div>`;
                const editorBody = document.createElement('div');
                editorBody.style.padding = '10px';
                editorBody.style.overflowY = 'auto';

                if (this.selectedId) {
                    const item = this.data.events.find(x => x.id === this.selectedId);
                    if (item) this.renderEventForm(editorBody, item);
                } else {
                    editorBody.innerHTML = '<div style="color:#666; text-align:center; margin-top:50px;">è¯·é€‰æ‹©ä¸€ä¸ªäº‹ä»¶è¿›è¡Œç¼–è¾‘</div>';
                }
                colEditor.appendChild(editorBody);

                layout.appendChild(colNodes);
                layout.appendChild(colEvents);
                layout.appendChild(colEditor);
                container.appendChild(layout);
            },

            setTlWorld(id) {
                this.tlWorldId = id;
                this.tlFilter = null;
                this.selectedId = null;
                this.render();
            },

            addKeyNode() {
                const age = prompt("Enter Age for Key Node:");
                if (age !== null) {
                    const intAge = parseInt(age);
                    this.tlFilter = { min: intAge, max: intAge, key: `${intAge}-${intAge}` };
                    this.render();
                }
            },

            addPool() {
                const range = prompt("Enter Age Range (e.g., 0-10):");
                if (range) {
                    const parts = range.split('-');
                    if (parts.length === 2) {
                        const min = parseInt(parts[0]);
                        const max = parseInt(parts[1]);
                        this.tlFilter = { min, max, key: `${min}-${max}` };
                        this.render();
                    }
                }
            },

            addCustomNode() {
                const age = parseInt(document.getElementById('quick-age').value) || 0;
                const attr = document.getElementById('quick-attr').value;
                const val = parseInt(document.getElementById('quick-val').value) || 0;
                const text = document.getElementById('quick-text').value;

                if (!this.tlWorldId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸–ç•Œ!');
                    return;
                }

                const newEvt = {
                    id: Date.now().toString(),
                    worldId: this.tlWorldId,
                    minAge: age,
                    maxAge: age,
                    text: text || 'æ–°èŠ‚ç‚¹äº‹ä»¶',
                    effect: {}
                };

                if (attr && val !== 0) {
                    newEvt.effect[attr] = val;
                }

                this.data.events.push(newEvt);

                // Auto-select filter to show it
                this.tlFilter = { min: age, max: age, key: `${age}-${age}` };
                this.selectedId = newEvt.id;
                this.render();
            },


            // --- Generic Renderers (Reused) ---

            // Grouped Talent List Renderer
            renderTalentList(container, list, formRenderer) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.height = '100%';
                wrapper.style.gap = '20px';

                const listCol = document.createElement('div');
                listCol.style.width = '300px';
                listCol.style.overflowY = 'auto';
                listCol.style.paddingRight = '10px';

                // Group by World
                const groups = {};
                this.data.worlds.forEach(w => groups[w.id] = { name: w.name, talents: [] });
                groups['__unassigned'] = { name: 'æœªåˆ†é…', talents: [] };

                list.forEach(t => {
                    if (groups[t.worldId]) {
                        groups[t.worldId].talents.push(t);
                    } else {
                        groups['__unassigned'].talents.push(t);
                    }
                });

                // Render Groups
                Object.keys(groups).forEach(worldId => {
                    const group = groups[worldId];
                    if (group.talents.length === 0 && worldId === '__unassigned') return;

                    const details = document.createElement('details');
                    details.open = true;
                    details.style.marginBottom = '10px';
                    details.style.border = '1px solid #444';
                    details.style.borderRadius = '4px';
                    details.style.background = '#222';

                    const summary = document.createElement('summary');
                    summary.style.padding = '8px';
                    summary.style.cursor = 'pointer';
                    summary.style.fontWeight = 'bold';
                    summary.style.background = '#333';
                    summary.style.display = 'flex';
                    summary.style.justifyContent = 'space-between';
                    summary.style.alignItems = 'center';
                    summary.innerHTML = `<span>${group.name} (${group.talents.length})</span>`;

                    const addGrpBtn = document.createElement('button');
                    addGrpBtn.className = 'btn btn-success';
                    addGrpBtn.innerText = '+';
                    addGrpBtn.title = 'æ·»åŠ å¤©èµ‹';
                    addGrpBtn.style.padding = '2px 8px';
                    addGrpBtn.style.fontSize = '0.8em';
                    addGrpBtn.style.lineHeight = '1';
                    addGrpBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const newItem = {
                            id: Date.now().toString(),
                            name: 'æ–°å¤©èµ‹',
                            desc: '',
                            worldId: worldId === '__unassigned' ? '' : worldId,
                            effect: {}
                        };
                        this.data.talents.push(newItem);
                        this.selectedId = newItem.id;
                        this.render();
                    };
                    summary.appendChild(addGrpBtn);
                    details.appendChild(summary);

                    const content = document.createElement('div');
                    content.style.padding = '5px';

                    group.talents.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `list-item ${item.id === this.selectedId ? 'selected' : ''}`;
                        div.style.fontSize = '0.9em';
                        div.style.marginBottom = '2px';

                        const effStr = Object.entries(item.effect || {}).map(([k, v]) => `${k}:${v > 0 ? '+' : ''}${v}`).join(' ');
                        const qColor = this.getQualityColor(item.grade);
                        div.innerHTML = `<span style="color:${qColor}; margin-right:5px; font-weight:${item.grade > 0 ? 'bold' : 'normal'}">${item.name}</span><small style="color:#888;">${effStr}</small>`;
                        div.onclick = (e) => {
                            e.stopPropagation();
                            this.selectedId = item.id;
                            this.render();
                        };

                        const delBtn = document.createElement('button');
                        delBtn.innerText = 'x';
                        delBtn.className = 'btn btn-danger';
                        delBtn.style.padding = '0px 5px';
                        delBtn.style.marginLeft = 'auto';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®è®¤åˆ é™¤è¯¥å¤©èµ‹?')) {
                                const idx = this.data.talents.findIndex(x => x.id === item.id);
                                if (idx > -1) {
                                    this.data.talents.splice(idx, 1);
                                    if (this.selectedId === item.id) this.selectedId = null;
                                    this.render();
                                }
                            }
                        };
                        div.appendChild(delBtn);
                        content.appendChild(div);
                    });

                    details.appendChild(content);
                    listCol.appendChild(details);
                });

                const formCol = document.createElement('div');
                formCol.style.flexGrow = 1;
                formCol.style.overflowY = 'auto';
                formCol.style.paddingLeft = '10px';

                if (this.selectedId) {
                    const item = list.find(x => x.id === this.selectedId);
                    if (item) formRenderer.call(this, formCol, item);
                } else {
                    formCol.innerHTML = '<div style="color:#666; text-align:center; margin-top:50px;">è¯·é€‰æ‹©ä¸€ä¸ªå¤©èµ‹è¿›è¡Œç¼–è¾‘</div>';
                }

                wrapper.appendChild(listCol);
                wrapper.appendChild(formCol);
                container.appendChild(wrapper);
            },

            // Grouped Event List Renderer
            // Grouped Event List Renderer
            renderEventList(container, list, formRenderer) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.height = '100%';
                wrapper.style.gap = '20px';

                const listCol = document.createElement('div');
                listCol.style.width = '300px';
                listCol.style.overflowY = 'auto';
                listCol.style.paddingRight = '10px';

                // Group by World
                const groups = {};
                this.data.worlds.forEach(w => groups[w.id] = { name: w.name, events: [] });
                groups['__unassigned'] = { name: 'æœªåˆ†é… (Unassigned)', events: [] };

                list.forEach(e => {
                    if (groups[e.worldId]) {
                        groups[e.worldId].events.push(e);
                    } else {
                        groups['__unassigned'].events.push(e);
                    }
                });

                // Render Groups
                Object.keys(groups).forEach(worldId => {
                    const group = groups[worldId];
                    if (group.events.length === 0 && worldId === '__unassigned') return;

                    // Sort events by Age (Min then Max)
                    group.events.sort((a, b) => (a.minAge - b.minAge) || (a.maxAge - b.maxAge));

                    const details = document.createElement('details');
                    details.open = true; // Default open
                    details.style.marginBottom = '10px';
                    details.style.border = '1px solid #444';
                    details.style.borderRadius = '4px';
                    details.style.background = '#222';

                    const summary = document.createElement('summary');
                    summary.style.padding = '8px';
                    summary.style.cursor = 'pointer';
                    summary.style.fontWeight = 'bold';
                    summary.style.background = '#333';
                    summary.style.display = 'flex';
                    summary.style.justifyContent = 'space-between';
                    summary.style.alignItems = 'center';

                    // Summary Content with Add Button
                    summary.innerHTML = `<span>${group.name} (${group.events.length})</span>`;

                    // Add Button in Header (Stop propagation to prevent toggle)
                    const addGrpBtn = document.createElement('button');
                    addGrpBtn.className = 'btn btn-success';
                    addGrpBtn.innerText = '+';
                    addGrpBtn.title = 'æ·»åŠ äº‹ä»¶ (Add Event)';
                    addGrpBtn.style.padding = '2px 8px';
                    addGrpBtn.style.fontSize = '0.8em';
                    addGrpBtn.style.lineHeight = '1';
                    addGrpBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const newItem = {
                            id: this._generateShortId(),
                            text: 'æ–°äº‹ä»¶ (New Event)',
                            worldId: worldId === '__unassigned' ? '' : worldId,
                            minAge: 0,
                            maxAge: 100
                        };
                        this.data.events.push(newItem);
                        this.selectedId = newItem.id;
                        this.render();
                    };
                    summary.appendChild(addGrpBtn);

                    details.appendChild(summary);

                    const content = document.createElement('div');
                    content.style.padding = '5px';

                    group.events.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `list-item ${item.id === this.selectedId ? 'selected' : ''}`;
                        div.style.fontSize = '0.9em';
                        div.style.marginBottom = '2px';

                        let title = item.text ? item.text.substring(0, 20) + '...' : 'Untitled';
                        const ageStr = (item.minAge === item.maxAge) ? `[${item.minAge}]` : `[${item.minAge}-${item.maxAge}]`;

                        div.innerHTML = `<span style="color:#aaa; margin-right:5px;">${ageStr}</span>${title}`;
                        div.onclick = (e) => {
                            e.stopPropagation(); // prevent closing details
                            this.selectedId = item.id;
                            this.render();
                        };

                        const delBtn = document.createElement('button');
                        delBtn.innerText = 'x';
                        delBtn.className = 'btn btn-danger';
                        delBtn.style.padding = '0px 5px';
                        delBtn.style.marginLeft = 'auto';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®è®¤åˆ é™¤? (Delete?)')) {
                                const idx = this.data.events.findIndex(x => x.id === item.id);
                                if (idx > -1) {
                                    this.data.events.splice(idx, 1);
                                    if (this.selectedId === item.id) this.selectedId = null;
                                    this.render();
                                }
                            }
                        };
                        div.appendChild(delBtn);
                        content.appendChild(div);
                    });

                    details.appendChild(content);
                    listCol.appendChild(details);
                });

                const formCol = document.createElement('div');
                formCol.style.flexGrow = 1;
                formCol.style.overflowY = 'auto';
                formCol.style.paddingLeft = '10px';

                if (this.selectedId) {
                    const item = list.find(x => x.id === this.selectedId);
                    if (item) formRenderer.call(this, formCol, item);
                } else {
                    formCol.innerHTML = '<div style="color:#666; text-align:center; margin-top:50px;">è¯·é€‰æ‹©ä¸€ä¸ªäº‹ä»¶è¿›è¡Œç¼–è¾‘</div>';
                }

                wrapper.appendChild(listCol);
                wrapper.appendChild(formCol);
                container.appendChild(wrapper);
            },

            renderList(container, list, formRenderer) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.height = '100%';
                wrapper.style.gap = '20px';

                const listCol = document.createElement('div');
                listCol.style.width = '300px';
                listCol.style.overflowY = 'auto';

                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-success';
                addBtn.innerText = '+ æ–°å»º (Add New)';
                addBtn.style.width = '100%';
                addBtn.style.marginBottom = '10px';
                addBtn.onclick = () => {
                    const newItem = { id: Date.now().toString(), name: 'æ–°é¡¹ç›® (New Item)' };
                    if (this.currentView === 'events') newItem.text = 'æ–°äº‹ä»¶ (New Event)';
                    if (this.currentView === 'worlds') newItem.uniqueAttributes = []; // Fix: Initialize attributes
                    list.push(newItem);
                    this.selectedId = newItem.id;
                    this.render();
                };
                listCol.appendChild(addBtn);

                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `list-item ${item.id === this.selectedId ? 'selected' : ''}`;

                    let title = item.name || '';
                    if (!title && item.text) {
                        title = item.text.substring(0, 20) + '...';
                    }
                    if (!title) title = 'Untitled';

                    // Special display for Events: Show Age Range
                    if (this.currentView === 'events') {
                        const ageStr = (item.minAge === item.maxAge) ? `[Age ${item.minAge}]` : `[Age ${item.minAge}-${item.maxAge}]`;
                        // Also show World ID briefly if needed, but sorting handles grouping. 
                        // Let's just prepend Age.
                        title = `<span style="color:#aaa; font-size:0.8em; margin-right:5px;">${ageStr}</span> ${title}`;
                    }

                    div.innerHTML = `<span>${title}</span>`;
                    div.onclick = () => { this.selectedId = item.id; this.render(); };

                    const delBtn = document.createElement('button');
                    delBtn.innerText = 'x';
                    delBtn.className = 'btn btn-danger';
                    delBtn.style.padding = '2px 6px';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('ç¡®è®¤åˆ é™¤?')) {
                            const idx = list.findIndex(x => x.id === item.id);
                            list.splice(idx, 1);
                            if (this.selectedId === item.id) this.selectedId = null;
                            this.render();
                        }
                    };
                    div.appendChild(delBtn);
                    listCol.appendChild(div);
                });

                const formCol = document.createElement('div');
                formCol.style.flexGrow = 1;
                formCol.style.overflowY = 'auto';

                if (this.selectedId) {
                    const item = list.find(x => x.id === this.selectedId);
                    if (item) formRenderer.call(this, formCol, item);
                } else {
                    formCol.innerHTML = '<div style="color:#666; text-align:center; margin-top:50px;">è¯·é€‰æ‹©ç¼–è¾‘é¡¹ (Select an item to edit)</div>';
                }

                wrapper.appendChild(listCol);
                wrapper.appendChild(formCol);
                container.appendChild(wrapper);
            },

            updateTempRule(worldId, key, val) {
                if (!this.tempEndingRules[worldId]) {
                    this.tempEndingRules[worldId] = { left: 'age', op: '>=', right: '', endingId: '' };
                }
                this.tempEndingRules[worldId][key] = val;
            },

            renderWorldForm(container, item) {
                container.innerHTML = `
            <h3>ç¼–è¾‘ä¸–ç•Œ (Edit World)</h3>
            <div class="form-group"><label>ID</label><input type="text" value="${item.id}" onchange="app.updateItem('id', this.value)"></div>
            <div class="form-group"><label>åç§° (Name)</label><input type="text" value="${item.name}" oninput="app.updateItemSilent('name', this.value)"></div>
            <div class="form-group"><label>æè¿° (Desc)</label><textarea rows="3" oninput="app.updateItemSilent('desc', this.value)">${item.desc || ''}</textarea></div>
            
            <div class="form-group">
                <label>ä¸–ç•Œä¸“å±å±æ€§ (Unique Attributes)</label>
                <div style="background:#333; padding:10px; border:1px solid #555; border-radius:4px;">
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                        ${(item.uniqueAttributes || []).map(attr => `
                            <span style="background:#444; padding:2px 8px; border-radius:10px; font-size:0.9em; display:flex; align-items:center; gap:5px;">
                                ${attr}
                                <button onclick="app.removeWorldAttr('${item.id}', '${attr}')" style="background:none; border:none; color:#cf6679; cursor:pointer; font-weight:bold;">Ã—</button>
                            </span>
                        `).join('')}
                    </div>
                    <div class="flex-row">
                        <input type="text" id="new-world-attr" placeholder="æ–°å±æ€§å (New Attribute)" style="flex:1;">
                        <button class="btn btn-success" onclick="app.addWorldAttr('${item.id}')">+</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ç»“å±€è§¦å‘æ¡ä»¶ (Ending Triggers)</label>
                <div style="background:#333; padding:10px; border:1px solid #555; border-radius:4px;">
                    <div style="margin-bottom:10px; font-size:0.9em; color:#aaa;">æ»¡è¶³æ¡ä»¶æ—¶è‡ªåŠ¨è§¦å‘æŒ‡å®šç»“å±€ (ä¾‹: å¹´é¾„ >= å¯¿å…ƒ -> å¯¿å°½)</div>
                    ${(item.endingRules || []).map((rule, idx) => `
                        <div class="flex-row" style="margin-bottom:5px; gap:5px; background:#444; padding:5px; border-radius:4px;">
                            <span style="color:#fff;">${rule.left}</span>
                            <span style="color:#cc7832;">${rule.op}</span>
                            <span style="color:#fff;">${rule.right}</span>
                            <span style="color:#aaa;">â†’</span>
                            <span style="color:#9876aa; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                ${(this.data.endings.find(e => e.id === rule.endingId) || { name: rule.endingId }).name}
                            </span>
                            <button class="btn btn-danger" style="padding:0 5px;" onclick="app.removeEndingRule('${item.id}', ${idx})">Ã—</button>
                        </div>
                    `).join('')}
                    
                    <div class="flex-row" style="gap:5px; margin-top:10px; padding-top:10px; border-top:1px solid #555;">
                        <select id="rule-left" style="width:100px;" onchange="app.updateTempRule('${item.id}', 'left', this.value)">
                            <option value="age" ${this.tempEndingRules[item.id]?.left === 'age' ? 'selected' : ''}>å¹´é¾„ (Age)</option>
                            ${(item.uniqueAttributes || []).map(a => `<option value="${a}" ${this.tempEndingRules[item.id]?.left === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                        <select id="rule-op" style="width:60px;" onchange="app.updateTempRule('${item.id}', 'op', this.value)">
                            <option value=">=" ${this.tempEndingRules[item.id]?.op === '>=' ? 'selected' : ''}>â‰¥</option>
                            <option value="<=" ${this.tempEndingRules[item.id]?.op === '<=' ? 'selected' : ''}>â‰¤</option>
                            <option value="==" ${this.tempEndingRules[item.id]?.op === '==' ? 'selected' : ''}>=</option>
                            <option value=">" ${this.tempEndingRules[item.id]?.op === '>' ? 'selected' : ''}>></option>
                            <option value="<" ${this.tempEndingRules[item.id]?.op === '<' ? 'selected' : ''}><</option>
                        </select>
                        <input type="text" id="rule-right" placeholder="æ•°å€¼/å±æ€§å" style="width:80px;" 
                            value="${this.tempEndingRules[item.id]?.right || ''}" 
                            oninput="app.updateTempRule('${item.id}', 'right', this.value)">
                        <span style="color:#aaa;">â†’</span>
                        <select id="rule-ending" style="flex:1;" onchange="app.updateTempRule('${item.id}', 'endingId', this.value)">
                            <option value="">-- é€‰æ‹©ç»“å±€ --</option>
                            ${this.data.endings.filter(e => !e.worldId || e.worldId === item.id).map(e => `<option value="${e.id}" ${this.tempEndingRules[item.id]?.endingId === e.id ? 'selected' : ''}>[${e.priority || 0}] ${e.name}</option>`).join('')}
                        </select>
                        <button class="btn btn-success" onclick="app.addEndingRule('${item.id}')">+</button>
                    </div>
                </div>
            </div>
        `;
            },

            addEndingRule(worldId) {
                const left = document.getElementById('rule-left').value;
                const op = document.getElementById('rule-op').value;
                let right = document.getElementById('rule-right').value;
                const endingId = document.getElementById('rule-ending').value;

                if (right) right = right.trim();

                if (!left || !op || !right || !endingId) {
                    alert('è¯·å¡«å†™å®Œæ•´è§„åˆ™!');
                    return;
                }

                const world = this.data.worlds.find(w => w.id === worldId);
                if (world) {
                    if (!world.endingRules) world.endingRules = [];
                    world.endingRules.push({ left, op, right, endingId });

                    // Clear temp state
                    if (this.tempEndingRules[worldId]) {
                        delete this.tempEndingRules[worldId];
                    }
                    this.render();
                }
            },

            updateTempRule(worldId, key, val) {
                if (!this.tempEndingRules[worldId]) {
                    this.tempEndingRules[worldId] = { left: 'age', op: '>=', right: '', endingId: '' };
                }
                this.tempEndingRules[worldId][key] = val;
            },

            removeEndingRule(worldId, idx) {
                const world = this.data.worlds.find(w => w.id === worldId);
                if (world && world.endingRules) {
                    world.endingRules.splice(idx, 1);
                    this.render();
                }

            },

            addWorldAttr(worldId) {
                const input = document.getElementById('new-world-attr');
                const val = input.value.trim();
                if (!val) return;

                const world = this.data.worlds.find(w => w.id === worldId);
                if (world) {
                    if (!world.uniqueAttributes) world.uniqueAttributes = [];
                    if (!world.uniqueAttributes.includes(val)) {
                        world.uniqueAttributes.push(val);
                        this.render();
                    }
                }
            },

            removeWorldAttr(worldId, attr) {
                const world = this.data.worlds.find(w => w.id === worldId);
                if (world && world.uniqueAttributes) {
                    world.uniqueAttributes = world.uniqueAttributes.filter(a => a !== attr);
                    this.render();
                }
            },

            renderTalentForm(container, item) {
                container.innerHTML = `
            <h3>ç¼–è¾‘å¤©èµ‹ (Edit Talent)</h3>
            <div class="form-group"><label>å¤©èµ‹åç§° (Name)</label><input type="text" value="${item.name || ''}" onchange="app.updateItem('name', this.value)"></div>
            <div class="form-group"><label>ä¸–ç•ŒID (World ID)</label>
                <select onchange="app.updateItem('worldId', this.value)">
                    <option value="">-- é€‰æ‹©ä¸–ç•Œ --</option>
                    ${this.data.worlds.map(w => `<option value="${w.id}" ${w.id === item.worldId ? 'selected' : ''}>${w.name}</option>`).join('')}
                </select>
            </div>
            <div class="flex-row">
                <div class="form-group" style="flex:1;"><label>æœ€å°å¹´é¾„ (Min Age)</label><input type="number" value="${item.minAge || 0}" onchange="app.updateItem('minAge', parseInt(this.value))"></div>
                <div class="form-group" style="flex:1;"><label>æœ€å¤§å¹´é¾„ (Max Age)</label><input type="number" value="${item.maxAge || 0}" onchange="app.updateItem('maxAge', parseInt(this.value))"></div>
                <div class="form-group" style="width:100px;">
                    <label>å“è´¨ (Quality)</label>
                    <select onchange="app.updateItem('grade', parseInt(this.value))" style="color:${this.getQualityColor(item.grade)}; font-weight:bold;">
                        <option value="0" ${item.grade === 0 ? 'selected' : ''} style="color:#e0e0e0;">æ™®é€š (White)</option>
                        <option value="1" ${item.grade === 1 ? 'selected' : ''} style="color:#42a5f5;">ç¨€æœ‰ (Blue)</option>
                        <option value="2" ${item.grade === 2 ? 'selected' : ''} style="color:#ab47bc;">å²è¯— (Purple)</option>
                        <option value="3" ${item.grade === 3 ? 'selected' : ''} style="color:#ffa726;">ä¼ è¯´ (Orange)</option>
                        <option value="4" ${item.grade === 4 ? 'selected' : ''} style="color:#ef5350;">ç¥è¯ (Red)</option>
                    </select>
                </div>
            </div>
            <div class="form-group"><label>å¤©èµ‹æè¿° (Desc)</label><input type="text" value="${item.desc || ''}" onchange="app.updateItem('desc', this.value)"></div>
            <div class="form-group"><label>å¤©èµ‹æ–‡æœ¬ (Text)</label><textarea rows="3" oninput="app.updateItemSilent('text', this.value)">${item.text || ''}</textarea></div>
        `;
                // Visual Condition Editor for talent
                // Visual Condition Editor for talent - REMOVED per user request
                // this.renderConditionEditor(container, item);
                this.renderEffectEditor(container, item, 'effect');

                // Visual choice editor for talent - REMOVED per user request
                // this.renderChoiceEditor(container, item);
            },

            renderEventForm(container, item) {
                container.innerHTML = `
            <h3>ç¼–è¾‘äº‹ä»¶ (Edit Event)</h3>
            <div class="form-group">
                <label>äº‹ä»¶ID (Event ID)</label>
                <div class="flex-row">
                    <input type="text" value="${item.id}" readonly style="flex:1; background:#333; color:#aaa; font-family:monospace;">
                    <button class="btn" onclick="navigator.clipboard.writeText('${item.id}'); alert('IDå·²å¤åˆ¶!')" title="å¤åˆ¶ID">ğŸ“‹</button>
                    <button class="btn btn-warning" onclick="app.regenerateEventId('${item.id}')" title="é‡æ–°ç”ŸæˆçŸ­ID">ğŸ”„</button>
                </div>
            </div>
            <div class="form-group"><label>ä¸–ç•ŒID (World ID)</label>
                <select onchange="app.updateItem('worldId', this.value)">
                    <option value="">-- é€‰æ‹©ä¸–ç•Œ --</option>
                    ${this.data.worlds.map(w => `<option value="${w.id}" ${w.id === item.worldId ? 'selected' : ''}>${w.name}</option>`).join('')}
                </select>
            </div>
            <div class="flex-row">
                <div class="form-group" style="flex:1;"><label>æœ€å°å¹´é¾„ (Min Age)</label><input type="number" value="${item.minAge || 0}" onchange="app.updateItem('minAge', parseInt(this.value))"></div>
                <div class="form-group" style="flex:1;"><label>æœ€å¤§å¹´é¾„ (Max Age)</label><input type="number" value="${item.maxAge || 100}" onchange="app.updateItem('maxAge', parseInt(this.value))"></div>
                <div class="form-group" style="width:80px;"><label>æ¦‚ç‡%</label><input type="number" min="0" max="100" value="${item.prob !== undefined ? item.prob : 100}" onchange="app.updateItem('prob', parseFloat(this.value))"></div>
            </div>
            <div class="form-group">
                <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" ${item.once ? 'checked' : ''} onchange="app.updateItem('once', this.checked)" style="width:auto;">
                    ä»…è§¦å‘ä¸€æ¬¡ (Once)
                </label>
            </div>
            <div class="form-group"><label>äº‹ä»¶å†…å®¹ (Text)</label><textarea rows="3" oninput="app.updateItemSilent('text', this.value)">${item.text || ''}</textarea></div>
                `;
                // Visual Condition Editor
                this.renderConditionEditor(container, item);

                this.renderEffectEditor(container, item, 'effect');

                // Visual Choice Editor
                this.renderChoiceEditor(container, item);
            },

            // --- Visual Effect Editor ---
            renderEffectEditor(container, item, fieldName = 'effect') {
                const effect = item[fieldName] || {};
                const worldId = item.worldId;
                const world = this.data.worlds.find(w => w.id === worldId);

                // Base attributes from world + Globals
                let availableAttrs = [];
                if (world) {
                    availableAttrs = [...(world.uniqueAttributes || [])]; // Fix: Safety check
                } else {
                    availableAttrs = ['è¯·å…ˆé€‰æ‹©ä¸–ç•Œ'];
                }

                let html = '<div style="background:#222; padding:10px; border-radius:4px; border:1px solid #444;">';

                // Existing Effects
                const entries = Object.entries(effect);
                if (entries.length === 0) {
                    html += '<div style="color:#666; font-size:0.9em; margin-bottom:5px;">æ— æ•ˆæœ</div>';
                }

                entries.forEach(([key, val]) => {
                    html += `
                    <div class="flex-row" style="margin-bottom:5px;">
                    <span style="width:80px; color:#aaa; font-size:0.9em;">${key}</span>
                    <input type="number" value="${val}" style="flex:1;" 
                        onchange="app.updateEffect('${item.id}', '${fieldName}', '${key}', parseFloat(this.value))">
                    <button class="btn btn-danger" style="padding:2px 8px;" 
                        onclick="app.removeEffect('${item.id}', '${fieldName}', '${key}')">x</button>
                </div>
                `;
                });

                // Add New Effect UI
                html += `
                    <div class="flex-row" style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                <select id="new-attr-${item.id}" style="flex:1;">
                    ${availableAttrs.map(a => `<option value="${a}">${a}</option>`).join('')}
                </select>
                <input type="number" id="new-val-${item.id}" placeholder="0" style="width:60px;">
                <button class="btn btn-success" style="padding:4px 10px;"
                    onclick="app.addEffect('${item.id}', '${fieldName}')">+</button>
            </div>
                `;

                html += '</div>';
                // Append directly to container instead of innerHTML replacement to avoid losing focus if used inside loop (not case here)
                const wrapper = document.createElement('div');
                wrapper.className = 'form-group';
                wrapper.innerHTML = `<label>æ•ˆæœ (Effects)</label>${html}`;
                container.appendChild(wrapper);
            },

            // --- Ending Renderer ---
            renderEndingList(container, list, renderer) {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.height = '100%';
                wrapper.style.gap = '20px';

                const listCol = document.createElement('div');
                listCol.style.width = '300px';
                listCol.style.overflowY = 'auto';
                listCol.style.paddingRight = '10px';

                // Group by World
                const groups = {};
                this.data.worlds.forEach(w => groups[w.id] = { name: w.name, endings: [] });
                groups['__unassigned'] = { name: 'æœªåˆ†é… (Unassigned)', endings: [] };

                list.forEach(e => {
                    if (groups[e.worldId]) {
                        groups[e.worldId].endings.push(e);
                    } else {
                        groups['__unassigned'].endings.push(e);
                    }
                });

                // Render Groups
                Object.keys(groups).forEach(worldId => {
                    const group = groups[worldId];
                    if (group.endings.length === 0 && worldId === '__unassigned') return;

                    const details = document.createElement('details');
                    details.open = true;
                    details.style.marginBottom = '10px';
                    details.style.border = '1px solid #444';
                    details.style.borderRadius = '4px';
                    details.style.background = '#222';

                    const summary = document.createElement('summary');
                    summary.style.padding = '8px';
                    summary.style.cursor = 'pointer';
                    summary.style.fontWeight = 'bold';
                    summary.style.background = '#333';
                    summary.style.display = 'flex';
                    summary.style.justifyContent = 'space-between';
                    summary.style.alignItems = 'center';
                    summary.innerHTML = `<span>${group.name} (${group.endings.length})</span>`;

                    const addGrpBtn = document.createElement('button');
                    addGrpBtn.className = 'btn btn-success';
                    addGrpBtn.innerText = '+';
                    addGrpBtn.title = 'æ·»åŠ ç»“å±€ (Add Ending)';
                    addGrpBtn.style.padding = '2px 8px';
                    addGrpBtn.style.fontSize = '0.8em';
                    addGrpBtn.style.lineHeight = '1';
                    addGrpBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const newItem = {
                            id: 'end_' + Math.random().toString(36).substr(2, 6),
                            name: 'æ–°ç»“å±€ (New Ending)',
                            desc: 'ç»“å±€æè¿°',
                            worldId: worldId === '__unassigned' ? '' : worldId,
                            priority: 50,
                            text: '<h1>ç»“å±€æ ‡é¢˜</h1><p>ç»“å±€å†…å®¹...</p>',
                            conditions: []
                        };
                        this.data.endings.push(newItem);
                        this.selectedId = newItem.id;
                        this.render();
                    };
                    summary.appendChild(addGrpBtn);
                    details.appendChild(summary);

                    const content = document.createElement('div');
                    content.style.padding = '5px';

                    // Sort by priority descending
                    group.endings.sort((a, b) => (b.priority || 0) - (a.priority || 0));

                    group.endings.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `list-item ${item.id === this.selectedId ? 'selected' : ''}`;
                        div.style.fontSize = '0.9em';
                        div.style.marginBottom = '2px';
                        div.innerHTML = `<span style="font-weight:bold; color:#ffa726; margin-right:5px;">[${item.priority || 0}]</span>${item.name}`;
                        div.onclick = (e) => {
                            e.stopPropagation();
                            this.selectedId = item.id;
                            this.render();
                        };

                        const delBtn = document.createElement('button');
                        delBtn.innerText = 'x';
                        delBtn.className = 'btn btn-danger';
                        delBtn.style.padding = '0px 5px';
                        delBtn.style.marginLeft = 'auto';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('ç¡®å®šåˆ é™¤è¯¥ç»“å±€å—?')) {
                                const idx = this.data.endings.indexOf(item);
                                this.data.endings.splice(idx, 1);
                                if (this.selectedId === item.id) this.selectedId = null;
                                this.render();
                            }
                        };
                        div.appendChild(delBtn);
                        content.appendChild(div);
                    });

                    details.appendChild(content);
                    listCol.appendChild(details);
                });

                const formCol = document.createElement('div');
                formCol.style.flexGrow = 1;
                formCol.style.overflowY = 'auto';
                formCol.style.paddingLeft = '10px';

                if (this.selectedId) {
                    const item = list.find(x => x.id === this.selectedId);
                    if (item && renderer) {
                        renderer.call(this, formCol, item);
                    }
                } else {
                    formCol.innerHTML = '<div style="color:#666; text-align:center; margin-top:50px;">è¯·é€‰æ‹©æˆ–æ·»åŠ ç»“å±€</div>';
                }

                wrapper.appendChild(listCol);
                wrapper.appendChild(formCol);
                container.appendChild(wrapper);
            },

            renderEndingForm(container, item) {
                container.innerHTML = `
            <h3>ç¼–è¾‘ç»“å±€ (Edit Ending)</h3>
            <div class="form-group"><label>ID</label><input type="text" value="${item.id}" readonly style="background:#333; color:#888;"></div>
            <div class="form-group"><label>æ‰€å±ä¸–ç•Œ (World)</label>
                <select onchange="app.updateItem('worldId', this.value)">
                    <option value="">-- é€‰æ‹©ä¸–ç•Œ --</option>
                    ${this.data.worlds.map(w => `<option value="${w.id}" ${w.id === item.worldId ? 'selected' : ''}>${w.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group"><label>ç»“å±€åç§° (Name)</label><input type="text" value="${item.name}" onchange="app.updateItem('name', this.value)"></div>
            <div class="form-group"><label>ç®€è¿° (Desc)</label><input type="text" value="${item.desc}" onchange="app.updateItem('desc', this.value)"></div>
            <div class="form-group"><label>ä¼˜å…ˆçº§ (Priority, é«˜ä¼˜å…ˆ)</label><input type="number" value="${item.priority || 0}" onchange="app.updateItem('priority', parseInt(this.value))"></div>
            
            <div class="form-group"><label>ç»“å±€å†…å®¹ (HTML)</label>
                <textarea rows="6" oninput="app.updateItemSilent('text', this.value)" style="font-family:monospace;">${item.text || ''}</textarea>
                <small style="color:#666;">æ”¯æŒHTMLæ ‡ç­¾: &lt;h1&gt;, &lt;p&gt;, &lt;img&gt; ç­‰</small>
            </div>
                `;
                this.renderConditionEditor(container, item);
            },

            // Helper methods for effect updates
            updateEffect(itemId, field, key, val) {
                // Find item in current list
                let list = this.currentView === 'timeline' ? this.data.events : this.getList(this.currentView);
                const item = list.find(x => x.id === itemId);
                if (item) {
                    if (!item[field]) item[field] = {};
                    item[field][key] = val;
                    // Trigger Re-render
                    this.render();

                    // Restore focus tricky? 
                    // Actually, re-rendering destroys DOM.
                    // For simple inputs, onchange runs AFTER blur/enter, so re-render is fine.
                }
            },

            removeEffect(itemId, field, key) {
                let list = this.currentView === 'timeline' ? this.data.events : this.getList(this.currentView);
                const item = list.find(x => x.id === itemId);
                if (item && item[field]) {
                    delete item[field][key];
                    this.render();
                }
            },

            addEffect(itemId, field) {
                const key = document.getElementById(`new-attr-${itemId}`).value;
                const valInput = document.getElementById(`new-val-${itemId}`);
                const val = parseFloat(valInput.value) || 0;

                if (key === 'è¯·å…ˆé€‰æ‹©ä¸–ç•Œ') return;

                let list = this.currentView === 'timeline' ? this.data.events : this.getList(this.currentView);
                const item = list.find(x => x.id === itemId);
                if (item) {
                    if (!item[field]) item[field] = {};
                    item[field][key] = val;
                    this.render();
                }
            },

            // --- Appearance / Theme Editor ---
            renderAppearance(container) {
                if (!this.data.theme) {
                    this.data.theme = {
                        title: 'åæ´¾æ¨¡æ‹Ÿå™¨', subtitle: 'Core Engine v1.0',
                        bgColor: '#121212', textColor: '#e0e0e0', accentColor: '#bb86fc',
                        secondaryColor: '#03dac6', panelBg: '#1e1e1e', borderColor: '#333'
                    };
                }
                const t = this.data.theme;

                container.innerHTML = `
            <h3>ğŸ¨ å¤–è§‚è®¾ç½®</h3>

            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:stretch;">
                <!-- Left: Settings -->
                <div style="flex:1; min-width:280px; display:flex; flex-direction:column; gap:15px;">
                    <div style="background:#222; padding:15px; border:1px solid #444; border-radius:4px;">
                        <h4 style="margin-top:0;">æ¸¸æˆæ ‡é¢˜</h4>
                        <div class="form-group">
                            <label>ä¸»æ ‡é¢˜</label>
                            <input type="text" value="${t.title}" oninput="app.updateTheme('title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>å‰¯æ ‡é¢˜</label>
                            <input type="text" value="${t.subtitle}" oninput="app.updateTheme('subtitle', this.value)">
                        </div>
                    </div>

                    <div style="background:#222; padding:15px; border:1px solid #444; border-radius:4px; flex:1;">
                        <h4 style="margin-top:0;">ç•Œé¢é¢œè‰²</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div class="form-group">
                                <label>èƒŒæ™¯è‰²</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.bgColor}" onchange="app.updateTheme('bgColor', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.bgColor}" oninput="app.updateTheme('bgColor', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>æ–‡å­—è‰²</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.textColor}" onchange="app.updateTheme('textColor', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.textColor}" oninput="app.updateTheme('textColor', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ä¸»é¢˜è‰² (æ ‡é¢˜/æŒ‰é’®)</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.accentColor}" onchange="app.updateTheme('accentColor', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.accentColor}" oninput="app.updateTheme('accentColor', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>è¾…åŠ©è‰² (é«˜äº®)</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.secondaryColor}" onchange="app.updateTheme('secondaryColor', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.secondaryColor}" oninput="app.updateTheme('secondaryColor', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>é¢æ¿èƒŒæ™¯</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.panelBg}" onchange="app.updateTheme('panelBg', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.panelBg}" oninput="app.updateTheme('panelBg', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>è¾¹æ¡†è‰²</label>
                                <div class="flex-row" style="gap:5px;">
                                    <input type="color" value="${t.borderColor}" onchange="app.updateTheme('borderColor', this.value)" style="width:40px; height:30px; padding:0; border:none; cursor:pointer;">
                                    <input type="text" value="${t.borderColor}" oninput="app.updateTheme('borderColor', this.value)" style="flex:1; font-family:monospace;">
                                </div>
                            </div>
                        </div>
                        <button class="btn" style="width:100%; margin-top:10px; background:#333;" onclick="app.resetTheme()">â†© æ¢å¤é»˜è®¤é¢œè‰²</button>
                    </div>
                </div>

                <!-- Right: Live Preview -->
                <div style="flex:1; min-width:280px; display:flex; flex-direction:column;">
                    <div style="background:#222; padding:15px; border:1px solid #444; border-radius:4px; flex:1; display:flex; flex-direction:column;">
                        <h4 style="margin-top:0;">å¼€å§‹ç•Œé¢é¢„è§ˆ</h4>
                        <div id="theme-preview" style="
                            background:${t.bgColor};
                            color:${t.textColor};
                            border:2px solid ${t.borderColor};
                            border-radius:8px;
                            overflow:hidden;
                            max-width:320px;
                            margin:0 auto;
                            flex:1;
                            width:100%;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                        ">
                            <!-- Simulated phone frame -->
                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:400px; padding:20px; text-align:center;">
                                <div style="flex:1;"></div>
                                <h1 style="color:${t.accentColor}; margin:0; font-size:1.8em;">${t.title}</h1>
                                <small style="color:#666; font-size:0.8em;">${t.subtitle}</small>
                                <div style="flex:1;"></div>
                                <button style="
                                    width:100%;
                                    padding:14px;
                                    font-size:1.1em;
                                    font-weight:bold;
                                    background:${t.accentColor};
                                    color:${t.bgColor};
                                    border:none;
                                    border-radius:4px;
                                    cursor:pointer;
                                    margin-bottom:10px;
                                ">å¼€å§‹æ¸¸æˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            },

            updateTheme(key, value) {
                if (!this.data.theme) this.data.theme = {};
                this.data.theme[key] = value;
                // Only update the preview, not the whole form (prevents losing input focus)
                const preview = document.getElementById('theme-preview');
                if (preview) {
                    const t = this.data.theme;
                    preview.style.background = t.bgColor;
                    preview.style.color = t.textColor;
                    preview.style.borderColor = t.borderColor;
                    preview.innerHTML = this._buildPreviewInner(t);
                }
            },

            _buildPreviewInner(t) {
                return `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:400px; padding:20px; text-align:center;">
                        <div style="flex:1;"></div>
                        <h1 style="color:${t.accentColor}; margin:0; font-size:1.8em;">${t.title}</h1>
                        <small style="color:#666; font-size:0.8em;">${t.subtitle}</small>
                        <div style="flex:1;"></div>
                        <button style="width:100%; padding:14px; font-size:1.1em; font-weight:bold; background:${t.accentColor}; color:${t.bgColor}; border:none; border-radius:4px; cursor:pointer; margin-bottom:10px;">å¼€å§‹æ¸¸æˆ</button>
                    </div>`;
            },

            resetTheme() {
                this.data.theme = {
                    title: 'åæ´¾æ¨¡æ‹Ÿå™¨', subtitle: 'Core Engine v1.0',
                    bgColor: '#121212', textColor: '#e0e0e0', accentColor: '#bb86fc',
                    secondaryColor: '#03dac6', panelBg: '#1e1e1e', borderColor: '#333'
                };
                this.render();
            },

            renderExport(container) {
                container.innerHTML = `
            <h3>æµ‹è¯•ä¸å¯¼å‡º</h3>
            
            <div style="background:#222; padding:15px; margin-bottom:20px; border:1px solid #444;">
                <h4 style="margin-top:0;">1. å¿«é€Ÿæµ‹è¯• (Quick Test)</h4>
                <p style="font-size:0.9em; color:#aaa;">ä¿å­˜å½“å‰é…ç½®åˆ°æµè§ˆå™¨ç¼“å­˜å¹¶å¯åŠ¨æ¸¸æˆã€‚</p>
                <button class="btn btn-primary" onclick="app.playDebug()">â–¶ å¯åŠ¨æµ‹è¯• / è°ƒè¯• (Play / Debug)</button>
            </div>

            <div style="background:#222; padding:15px; margin-bottom:20px; border:1px solid #444;">
                <h4 style="margin-top:0;">2. å¯¼å‡º / ç”Ÿæˆæ¸¸æˆ (Export)</h4>
                <div class="flex-row" style="gap:10px; flex-wrap:wrap;">
                    <button class="btn" style="background:#8e44ad; color:white;" onclick="app.downloadJSON()">ä¸‹è½½ JSON é…ç½®</button>
                    <button class="btn btn-success" onclick="app.generateStandalone()">â¬‡ ç”Ÿæˆç‹¬ç«‹æ¸¸æˆ (index.html)</button>
                </div>
            </div>

            <div style="background:#222; padding:15px; border:1px solid #444;">
                <h4 style="margin-top:0;">3. å¯¼å…¥é…ç½® (Import)</h4>
                <div class="flex-row" style="gap:10px; margin-bottom:10px;">
                    <input type="file" id="import-file" accept=".json,.yaml,.yml,.txt" style="flex:1;">
                    <button class="btn btn-success" onclick="app.importFromFile()">å¯¼å…¥æ–‡ä»¶</button>
                </div>
                <textarea id="io-area" style="height:80px; font-family:monospace; margin-bottom:10px;" placeholder="æˆ–ç²˜è´´ JSON / é…ç½®è¡¨..."></textarea>
                <div class="flex-row" style="gap:10px;">
                    <button class="btn btn-success" onclick="app.importFromArea()">å¯¼å…¥ JSON æ–‡æœ¬</button>
                    <button class="btn" style="background:#2980b9; color:white;" onclick="app.importConfigFromArea()">å¯¼å…¥é…ç½®è¡¨</button>
                </div>
            </div>

            <div style="background:#222; padding:15px; margin-top:20px; border:1px solid #444;">
                <h4 style="margin-top:0;">4. ğŸ“‹ é…ç½®è¡¨</h4>
                <p style="font-size:0.9em; color:#aaa;">ç”Ÿæˆç»“æ„åŒ–é…ç½®è¡¨ï¼Œå¯äº¤ç»™ AI å¡«å†™å†…å®¹åå¯¼å…¥ã€‚æ ¼å¼æ¸…æ™°ã€å¸¦å­—æ®µè¯´æ˜å’Œç¤ºä¾‹ã€‚</p>
                <div class="flex-row" style="gap:10px; flex-wrap:wrap;">
                    <button class="btn" style="background:#e67e22; color:white;" onclick="app.generateConfigTemplate()">ğŸ“‹ ç”Ÿæˆç©ºç™½é…ç½®è¡¨</button>
                    <button class="btn" style="background:#27ae60; color:white;" onclick="app.generateConfigTemplateFromData()">ğŸ“‹ ä»å½“å‰æ•°æ®ç”Ÿæˆé…ç½®è¡¨</button>
                </div>
            </div>
                `;
            },

            playDebug() {
                // Check for unsaved ending rules
                const hasUnsavedRules = Object.values(this.tempEndingRules || {}).some(r => r.right || r.endingId);
                if (hasUnsavedRules) {
                    if (!confirm('æ£€æµ‹åˆ°æ‚¨æœ‰æœªä¿å­˜çš„ç»“å±€è§¦å‘è§„åˆ™ï¼ˆå·²å¡«å†™ä½†æœªç‚¹å‡»æ·»åŠ æŒ‰é’®ï¼‰ã€‚\nè¿™äº›è§„åˆ™ä¸ä¼šåœ¨æµ‹è¯•ä¸­ç”Ÿæ•ˆã€‚\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                }

                // Check if game.html exists before opening
                fetch('game.html', { method: 'HEAD' })
                    .then(r => {
                        if (r.ok) {
                            localStorage.setItem('VILLAIN_SIM_DEBUG', JSON.stringify(this.data));
                            window.open('game.html', '_blank');
                        } else {
                            alert('âŒ æ— æ³•æ‰¾åˆ° game.html æ–‡ä»¶ï¼\n\nè¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦å·²å°† game.html ä¸Šä¼ åˆ° GitHub ä»“åº“ï¼Ÿ\n2. ä»“åº“æ ¹ç›®å½•ä¸‹æ˜¯å¦æœ‰ game.htmlï¼Ÿ\n3. å¦‚æœæ˜¯åˆšä¸Šä¼ ï¼Œè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®© GitHub Pages æ›´æ–°ã€‚');
                        }
                    })
                    .catch(() => {
                        // Network error or other issue, try opening anyway as fallback
                        localStorage.setItem('VILLAIN_SIM_DEBUG', JSON.stringify(this.data));
                        window.open('game.html', '_blank');
                    });
            },

            generateStandalone() {
                // Check for unsaved ending rules
                const hasUnsavedRules = Object.values(this.tempEndingRules || {}).some(r => r.right || r.endingId);
                if (hasUnsavedRules) {
                    if (!confirm('æ£€æµ‹åˆ°æ‚¨æœ‰æœªä¿å­˜çš„ç»“å±€è§¦å‘è§„åˆ™ï¼ˆå·²å¡«å†™ä½†æœªç‚¹å‡»æ·»åŠ æŒ‰é’®ï¼‰ã€‚\næ˜¯å¦å¿½ç•¥è¿™äº›è§„åˆ™å¹¶ç»§ç»­å¯¼å‡ºï¼Ÿ')) {
                        return;
                    }
                }

                // Read index.html from same directory via fetch, fallback to embedded template
                const config = JSON.stringify(this.data, null, 4);
                const newConfig = `let GAME_DATA = ${config}; `;

                // Try to fetch game.html from same directory
                fetch('game.html')
                    .then(r => {
                        if (!r.ok) throw new Error('game.html not found');
                        return r.text();
                    })
                    .then(html => {
                        const regex = /let GAME_DATA = \{[\s\S]*?\};/;
                        if (!regex.test(html)) {
                            alert('æœªåœ¨ game.html ä¸­æ‰¾åˆ° GAME_DATAï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ­£ç¡®ã€‚');
                            return;
                        }
                        const result = html.replace(regex, newConfig);
                        this._downloadHtml(result);
                    })
                    .catch((err) => {
                        console.error(err);
                        // Fallback: ask user to upload
                        if (confirm('âŒ æ— æ³•è¯»å– game.html æ¨¡æ¿ï¼(å¯èƒ½æœªä¸Šä¼ æˆ–ç½‘ç»œé—®é¢˜)\n\næ˜¯å¦æ‰‹åŠ¨é€‰æ‹©æœ¬åœ°çš„ game.html æ–‡ä»¶è¿›è¡Œç”Ÿæˆï¼Ÿ')) {
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = '.html';
                            input.onchange = (e) => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                    let html = ev.target.result;
                                    const regex = /let GAME_DATA = \{[\s\S]*?\};/;
                                    if (!regex.test(html)) {
                                        alert('æœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° GAME_DATAã€‚');
                                        return;
                                    }
                                    const result = html.replace(regex, newConfig);
                                    this._downloadHtml(result);
                                };
                                reader.readAsText(file);
                            };
                            input.click();
                        }
                    });
            },

            downloadJSON() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "villain_config.json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            _downloadText(text, filename) {
                const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(text);
                const a = document.createElement('a');
                a.setAttribute("href", dataStr);
                a.setAttribute("download", filename);
                document.body.appendChild(a);
                a.click();
                a.remove();
            },

            _generateShortId() {
                return 'e_' + Math.random().toString(36).substr(2, 6);
            },

            regenerateEventId(oldId) {
                if (!confirm('è­¦å‘Šï¼šé‡æ–°ç”ŸæˆIDä¼šå¯¼è‡´å¼•ç”¨è¯¥äº‹ä»¶çš„é€‰é¡¹å¤±æ•ˆï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
                const newId = this._generateShortId();
                const item = this.data.events.find(e => e.id === oldId);
                if (item) {
                    item.id = newId;
                    this.selectedId = newId;
                    this.render();
                }
            },

            getQualityColor(grade) {
                const colors = ['#e0e0e0', '#42a5f5', '#ab47bc', '#ffa726', '#ef5350'];
                return colors[grade || 0] || colors[0];
            },

            // --- AI Config Template ---
            _buildConfigTemplate(data) {
                const d = data || {};
                const theme = d.theme || {};
                const worlds = d.worlds || [];
                const talents = d.talents || [];
                const events = d.events || [];

                let lines = [];
                lines.push('# ========================================');
                lines.push('# æ¸¸æˆé…ç½®è¡¨ (Game Configuration Template)');
                lines.push('# ========================================');
                lines.push('# è¯´æ˜: è¯·æŒ‰ç…§æ ¼å¼å¡«å†™ï¼Œæ¯ä¸ªå­—æ®µå‰æœ‰ä¸­æ–‡è¯´æ˜ã€‚');
                lines.push('# AI å¡«å†™æŒ‡å—: ä¿æŒç¼©è¿›å’Œæ ¼å¼ä¸å˜ï¼Œåªä¿®æ”¹ ":" åé¢çš„å€¼ã€‚');
                lines.push('# å¡«å†™å®Œæˆåï¼Œåœ¨ç¼–è¾‘å™¨ä¸­ç‚¹å‡»"å¯¼å…¥é…ç½®è¡¨"å¯¼å…¥ã€‚');
                lines.push('');

                // --- Theme ---
                lines.push('# ----------------------------------------');
                lines.push('# ä¸€ã€å¤–è§‚è®¾ç½® (Theme)');
                lines.push('# ----------------------------------------');
                lines.push(`æ¸¸æˆæ ‡é¢˜: ${theme.title || 'æˆ‘çš„æ¸¸æˆ'}`);
                lines.push(`å‰¯æ ‡é¢˜: ${theme.subtitle || 'v1.0'}`);
                lines.push(`èƒŒæ™¯è‰²: ${theme.bgColor || '#121212'}`);
                lines.push(`æ–‡å­—è‰²: ${theme.textColor || '#e0e0e0'}`);
                lines.push(`ä¸»é¢˜è‰²: ${theme.accentColor || '#bb86fc'}`);
                lines.push(`è¾…åŠ©è‰²: ${theme.secondaryColor || '#03dac6'}`);
                lines.push(`é¢æ¿èƒŒæ™¯è‰²: ${theme.panelBg || '#1e1e1e'}`);
                lines.push(`è¾¹æ¡†è‰²: ${theme.borderColor || '#333'}`);
                lines.push(`å±æ€§ç‚¹æ•°: ${d.initialPoints || 20}`);
                lines.push('');

                // --- Worlds ---
                lines.push('# ----------------------------------------');
                lines.push('# äºŒã€ä¸–ç•Œåˆ—è¡¨ (Worlds)');
                lines.push('# æ¯ä¸ªä¸–ç•Œå®šä¹‰ä¸€å¥—ç‹¬ç«‹çš„å±æ€§ä½“ç³»');
                lines.push('# æ ¼å¼: ä¸–ç•ŒID | ä¸–ç•Œåç§° | æè¿° | å±æ€§1,å±æ€§2,å±æ€§3,...');
                lines.push('# ----------------------------------------');
                if (worlds.length > 0) {
                    worlds.forEach(w => {
                        lines.push(`ä¸–ç•Œ: ${w.id} | ${w.name} | ${w.desc} | ${w.uniqueAttributes.join(',')}`);
                    });
                } else {
                    lines.push('# ç¤ºä¾‹:');
                    lines.push('ä¸–ç•Œ: w_fantasy | ä¿®ä»™ä¸–ç•Œ | ä¸€ä¸ªå……æ»¡çµæ°”çš„ä¿®ä»™å¤§é™† | ä¿®ä¸º,æ ¹éª¨,é­”å¿µ,å¯¿å…ƒ');
                    lines.push('ä¸–ç•Œ: w_city | éƒ½å¸‚ä¸–ç•Œ | ç°ä»£éƒ½å¸‚ç”Ÿæ´» | æ™ºå•†,ä½“é­„,é‡‘é’±,äººè„‰');
                }
                lines.push('');

                // --- Talents ---
                lines.push('# ----------------------------------------');
                lines.push('# ä¸‰ã€å¤©èµ‹åˆ—è¡¨ (Talents)');
                lines.push('# ç©å®¶å¼€å±€å¯æŠ½å–çš„å¤©èµ‹ï¼Œæ¯ä¸ªå¤©èµ‹é™„å¸¦å±æ€§åŠ æˆ');
                lines.push('# æ ¼å¼: å¤©èµ‹ID | æ‰€å±ä¸–ç•ŒID | å¤©èµ‹å | æè¿° | å±æ€§å:åŠ æˆå€¼,å±æ€§å:åŠ æˆå€¼,...');
                lines.push('# å¯é€‰å­—æ®µ (å†™åœ¨å¤©èµ‹è¡Œä¸‹æ–¹ï¼Œç¼©è¿›2ç©ºæ ¼):');
                lines.push('#   å“è´¨: 0-4           â€” å¤©èµ‹å“è´¨ (0:ç™½, 1:è“, 2:ç´«, 3:æ©™, 4:çº¢)');
                lines.push('#   æ–‡æœ¬: xxx           â€” å¤©èµ‹è¯¦ç»†æ–‡æœ¬');
                lines.push('#   å¹´é¾„: min-max       â€” å¤©èµ‹é€‚ç”¨å¹´é¾„èŒƒå›´');
                lines.push('#   å¹´é¾„: min-max       â€” å¤©èµ‹é€‚ç”¨å¹´é¾„èŒƒå›´');
                // lines.push('#   æ¡ä»¶: å±æ€§å > æ•°å€¼    â€” è§¦å‘æ¡ä»¶ (æ”¯æŒ > < = >= <= != has)'); // Removed
                // lines.push('#   é€‰é¡¹: é€‰é¡¹æ–‡æœ¬ | å±æ€§å:å˜åŒ–å€¼,... | åç»­äº‹ä»¶ID    â€” æ·»åŠ é€‰æ‹©åˆ†æ”¯'); // Removed
                lines.push('# ----------------------------------------');
                if (talents.length > 0) {
                    talents.forEach(t => {
                        const eff = Object.entries(t.effect || {}).map(([k, v]) => `${k}:${v}`).join(',');
                        lines.push(`å¤©èµ‹: ${t.id} | ${t.worldId} | ${t.name} | ${t.desc || ''} | ${eff}`);
                        if (t.grade > 0) lines.push(`  å“è´¨: ${t.grade}`);
                        if (t.text) lines.push(`  æ–‡æœ¬: ${t.text}`);
                        if (t.minAge !== undefined || t.maxAge !== undefined) {
                            lines.push(`  å¹´é¾„: ${t.minAge || 0}-${t.maxAge || 0}`);
                        }
                        if (t.minAge !== undefined || t.maxAge !== undefined) {
                            lines.push(`  å¹´é¾„: ${t.minAge || 0}-${t.maxAge || 0}`);
                        }
                        // Conditions removed for talents

                        // Choices removed for talents
                        /*
                        if (t.choices && t.choices.length > 0) {
                            t.choices.forEach(ch => {
                                const chEff = Object.entries(ch.effect || {}).map(([k, v]) => `${k}:${v}`).join(',');
                                let chLine = `  é€‰é¡¹: ${ch.text} | ${chEff}`;
                                if (ch.nextEventId) chLine += ` | ${ch.nextEventId}`;
                                lines.push(chLine);
                            });
                        }
                        */
                    });
                } else {
                    lines.push('# ç¤ºä¾‹:');
                    lines.push('å¤©èµ‹: t_f_1 | w_fantasy | å¤©ç”Ÿé­”ç§ | é­”å¿µå¤§å¢ | é­”å¿µ:5');
                    lines.push('å¤©èµ‹: t_c_1 | w_city | å¯ŒäºŒä»£ | å®¶å¢ƒä¼˜æ¸¥ | é‡‘é’±:10');
                }
                lines.push('');

                // --- Events ---
                lines.push('# ----------------------------------------');
                lines.push('# å››ã€äº‹ä»¶åˆ—è¡¨ (Events)');
                lines.push('# æ¸¸æˆä¸­æŒ‰å¹´é¾„è§¦å‘çš„äº‹ä»¶');
                lines.push('# åŸºç¡€æ ¼å¼: äº‹ä»¶ID | æ‰€å±ä¸–ç•ŒID | æœ€å°å¹´é¾„ | æœ€å¤§å¹´é¾„ | äº‹ä»¶æ–‡æœ¬ | å±æ€§å:å˜åŒ–å€¼,...');
                lines.push('# å¯é€‰å­—æ®µ (å†™åœ¨äº‹ä»¶è¡Œä¸‹æ–¹ï¼Œç¼©è¿›2ç©ºæ ¼):');
                lines.push('#   once: true          â€” è¯¥äº‹ä»¶åªè§¦å‘ä¸€æ¬¡');
                lines.push('#   æ¦‚ç‡: 50            â€” è§¦å‘æ¦‚ç‡ (0-100ï¼Œé»˜è®¤100)');
                lines.push('#   æ¡ä»¶: å±æ€§å > æ•°å€¼    â€” è§¦å‘æ¡ä»¶ (æ”¯æŒ > < = >= <= != has)');
                lines.push('#   é€‰é¡¹: é€‰é¡¹æ–‡æœ¬ | å±æ€§å:å˜åŒ–å€¼,... | åç»­äº‹ä»¶ID    â€” æ·»åŠ é€‰æ‹©åˆ†æ”¯');
                lines.push('# ----------------------------------------');
                if (events.length > 0) {
                    events.forEach(ev => {
                        const eff = Object.entries(ev.effect || {}).map(([k, v]) => `${k}:${v}`).join(',');
                        lines.push(`äº‹ä»¶: ${ev.id} | ${ev.worldId} | ${ev.minAge} | ${ev.maxAge} | ${ev.text} | ${eff}`);
                        if (ev.once) lines.push('  once: true');
                        if (ev.prob !== undefined && ev.prob < 100) lines.push(`  æ¦‚ç‡: ${ev.prob}`);
                        if (ev.conditions && ev.conditions.length > 0) {
                            ev.conditions.forEach(c => {
                                lines.push(`  æ¡ä»¶: ${c.attr} ${c.op} ${c.val}`);
                            });
                        }
                        if (ev.choices && ev.choices.length > 0) {
                            ev.choices.forEach(ch => {
                                const chEff = Object.entries(ch.effect || {}).map(([k, v]) => `${k}:${v}`).join(',');
                                let chLine = `  é€‰é¡¹: ${ch.text} | ${chEff}`;
                                if (ch.nextEventId) chLine += ` | ${ch.nextEventId}`;
                                lines.push(chLine);
                            });
                        }
                    });
                } else {
                    lines.push('# ç¤ºä¾‹:');
                    lines.push('äº‹ä»¶: e_born | w_fantasy | 0 | 0 | ä½ å‡ºç”Ÿäº†ã€‚å‘¨å›´é­”æ°”ç¼­ç»•ã€‚ | é­”å¿µ:1');
                    lines.push('äº‹ä»¶: e_choice | w_fantasy | 10 | 20 | ä½ å‘ç°äº†ä¸€æœ¬ç§˜ç±ã€‚ | ');
                    lines.push('  once: true');
                    lines.push('  æ¡ä»¶: é­”å¿µ > 3');
                    lines.push('  é€‰é¡¹: ä¿®ç‚¼ç§˜ç± | é­”å¿µ:5');
                    lines.push('  é€‰é¡¹: é”€æ¯ç§˜ç± | ');
                }
                lines.push('');

                // --- Endings ---
                const endings = d.endings || [];
                lines.push('# ----------------------------------------');
                lines.push('# äº”ã€ç»“å±€åˆ—è¡¨ (Endings)');
                lines.push('# æ¸¸æˆç»“æŸæ—¶çš„åˆ¤å®š');
                lines.push('# æ ¼å¼: ç»“å±€ID | æ‰€å±ä¸–ç•ŒID | åç§° | ç®€è¿° | ä¼˜å…ˆçº§');
                lines.push('# å¯é€‰å­—æ®µ:');
                lines.push('#   æ¡ä»¶: å±æ€§å > æ•°å€¼   (æ”¯æŒ > < = >= <= != has)');
                lines.push('#   å†…å®¹: HTMLæ–‡æœ¬ (æ”¯æŒ \\n æ¢è¡Œ)');
                lines.push('# ----------------------------------------');
                if (endings.length > 0) {
                    endings.forEach(e => {
                        lines.push(`ç»“å±€: ${e.id} | ${e.worldId || ''} | ${e.name} | ${e.desc || ''} | ${e.priority || 0}`);
                        if (e.conditions && e.conditions.length > 0) {
                            e.conditions.forEach(c => {
                                lines.push(`  æ¡ä»¶: ${c.attr} ${c.op} ${c.val || ''}`.trimEnd());
                            });
                        }
                        if (e.text) {
                            const escapedText = e.text.replace(/\n/g, '\\n');
                            lines.push(`  å†…å®¹: ${escapedText}`);
                        }
                    });
                } else {
                    lines.push('# ç¤ºä¾‹:');
                    lines.push('ç»“å±€: end_1 | w_fantasy | é­”é“è‡³å°Š | ä½ æˆä¸ºäº†é­”é“è‡³å°Š | 10');
                    lines.push('  æ¡ä»¶: é­”å¿µ > 80');
                    lines.push('  å†…å®¹: <h1>é­”é“è‡³å°Š</h1><p>ä½ ç»ˆäºè¸ä¸Šäº†é­”é“çš„å·…å³°ã€‚</p>');
                    lines.push('ç»“å±€: end_2 | w_fantasy | é»˜é»˜æ— é—» | å¹³å‡¡çš„ä¸€ç”Ÿ | 0');
                }
                lines.push('');
                lines.push('# ========== é…ç½®è¡¨ç»“æŸ ==========');

                return lines.join('\n');
            },

            generateConfigTemplate() {
                const template = this._buildConfigTemplate({});
                this._downloadText(template, 'game_config_template.txt');
                // Also copy to clipboard
                navigator.clipboard.writeText(template).then(() => {
                    alert('ç©ºç™½é…ç½®è¡¨å·²ä¸‹è½½å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å¯ç›´æ¥å‘ç»™ AI å¡«å†™ã€‚');
                }).catch(() => {
                    alert('ç©ºç™½é…ç½®è¡¨å·²ä¸‹è½½ï¼');
                });
            },

            generateConfigTemplateFromData() {
                const template = this._buildConfigTemplate(this.data);
                this._downloadText(template, 'game_config_current.txt');
                navigator.clipboard.writeText(template).then(() => {
                    alert('å½“å‰æ•°æ®çš„é…ç½®è¡¨å·²ä¸‹è½½å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    alert('é…ç½®è¡¨å·²ä¸‹è½½ï¼');
                });
            },

            _downloadText(text, filename) {
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            },

            importConfigFromArea() {
                const text = document.getElementById('io-area').value.trim();
                if (!text) { alert('è¯·å…ˆç²˜è´´é…ç½®è¡¨å†…å®¹ï¼'); return; }
                this._parseConfigTemplate(text);
            },

            _parseConfigTemplate(text) {
                const lines = text.split('\n');
                const data = {
                    initialPoints: 20,
                    theme: { title: '', subtitle: '', bgColor: '#121212', textColor: '#e0e0e0', accentColor: '#bb86fc', secondaryColor: '#03dac6', panelBg: '#1e1e1e', borderColor: '#333' },
                    worlds: [],
                    talents: [],
                    events: [],
                    endings: []
                };

                let lastEvent = null;
                let lastTalent = null;
                let lastEnding = null;

                for (let raw of lines) {
                    const line = raw.trim();
                    if (!line || line.startsWith('#')) continue;

                    // Theme fields
                    if (line.startsWith('æ¸¸æˆæ ‡é¢˜:')) { data.theme.title = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('å‰¯æ ‡é¢˜:')) { data.theme.subtitle = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('èƒŒæ™¯è‰²:')) { data.theme.bgColor = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('æ–‡å­—è‰²:')) { data.theme.textColor = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('ä¸»é¢˜è‰²:')) { data.theme.accentColor = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('è¾…åŠ©è‰²:')) { data.theme.secondaryColor = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('é¢æ¿èƒŒæ™¯è‰²:')) { data.theme.panelBg = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('è¾¹æ¡†è‰²:')) { data.theme.borderColor = line.split(':').slice(1).join(':').trim(); continue; }
                    if (line.startsWith('å±æ€§ç‚¹æ•°:')) { data.initialPoints = parseInt(line.split(':')[1]) || 20; continue; }

                    // Worlds
                    if (line.startsWith('ä¸–ç•Œ:') || line.startsWith('ä¸–ç•Œï¼š')) {
                        const parts = line.substring(3).replace(/ï½œ/g, '|').split('|').map(s => s.trim());
                        if (parts.length >= 4) {
                            data.worlds.push({
                                id: parts[0], name: parts[1], desc: parts[2],
                                uniqueAttributes: parts[3].replace(/ï¼Œ/g, ',').split(',').map(s => s.trim()).filter(Boolean)
                            });
                        }
                        continue;
                    }

                    // Talents
                    if (line.startsWith('å¤©èµ‹:') || line.startsWith('å¤©èµ‹ï¼š')) {
                        const parts = line.substring(3).replace(/ï½œ/g, '|').split('|').map(s => s.trim());
                        if (parts.length >= 5) {
                            const effect = {};
                            parts[4].replace(/ï¼Œ/g, ',').split(',').forEach(pair => {
                                const [k, v] = pair.replace(/ï¼š/g, ':').split(':').map(s => s.trim());
                                if (k && v !== undefined) effect[k] = parseFloat(v) || 0;
                            });
                            const newTalent = {
                                id: parts[0], worldId: parts[1], name: parts[2], desc: parts[3], effect
                            };
                            data.talents.push(newTalent);
                            lastTalent = newTalent;
                            lastEvent = null;
                        }
                        continue;
                    }

                    // Events
                    if (line.startsWith('äº‹ä»¶:') || line.startsWith('äº‹ä»¶ï¼š')) {
                        const parts = line.substring(3).replace(/ï½œ/g, '|').split('|').map(s => s.trim());
                        if (parts.length >= 5) {
                            const effect = {};
                            if (parts[5]) {
                                parts[5].replace(/ï¼Œ/g, ',').split(',').forEach(pair => {
                                    const [k, v] = pair.replace(/ï¼š/g, ':').split(':').map(s => s.trim());
                                    if (k && v !== undefined) effect[k] = parseFloat(v) || 0;
                                });
                            }
                            lastEvent = {
                                id: parts[0], worldId: parts[1],
                                minAge: parseInt(parts[2]) || 0, maxAge: parseInt(parts[3]) || 100,
                                text: parts[4], effect
                            };
                            data.events.push(lastEvent);
                        }
                        continue;
                    }

                    // Endings (5-field: ID | worldId | name | desc | priority, or 4-field legacy: ID | name | desc | priority)
                    if (line.startsWith('ç»“å±€:') || line.startsWith('ç»“å±€ï¼š')) {
                        const parts = line.substring(3).replace(/ï½œ/g, '|').split('|').map(s => s.trim());
                        let newEnding;
                        if (parts.length >= 5) {
                            newEnding = {
                                id: parts[0], worldId: parts[1], name: parts[2], desc: parts[3], priority: parseInt(parts[4]) || 0, text: '', conditions: []
                            };
                        } else if (parts.length >= 4) {
                            newEnding = {
                                id: parts[0], name: parts[1], desc: parts[2], priority: parseInt(parts[3]) || 0, text: '', conditions: []
                            };
                        }
                        if (newEnding) {
                            if (!data.endings) data.endings = [];
                            data.endings.push(newEnding);
                            lastEnding = newEnding;
                            lastEvent = null;
                            lastTalent = null;
                        }
                        continue;
                    }

                    // Sub-fields (indented)
                    if (lastTalent && raw.startsWith('  ')) {
                        if (line.startsWith('å“è´¨:')) {
                            lastTalent.grade = parseInt(line.split(':')[1].replace(/ï¼š/g, ':')) || 0;
                        } else if (line.startsWith('æ–‡æœ¬:')) {
                            lastTalent.text = line.split(':')[1].replace(/ï¼š/g, ':').trim(); // Handle potential double colon if user typed "æ–‡æœ¬ï¼šxxx"
                            // Actually better: just take substring after first colon
                            const firstColon = line.indexOf(':') > -1 ? line.indexOf(':') : line.indexOf('ï¼š');
                            if (firstColon > -1) lastTalent.text = line.substring(firstColon + 1).trim();
                        } else if (line.startsWith('å¹´é¾„:')) {
                            const ageVal = line.split(':')[1].replace(/ï¼š/g, ':').trim();
                            const ageParts = ageVal.split('-');
                            lastTalent.minAge = parseInt(ageParts[0]) || 0;
                            lastTalent.maxAge = parseInt(ageParts[1]) || 0;
                        }
                    }

                    if (lastEnding && raw.startsWith('  ')) {
                        if (line.startsWith('å†…å®¹:')) {
                            // Handle HTML content, potentially multiline but for now simple
                            const firstColon = line.indexOf(':') > -1 ? line.indexOf(':') : line.indexOf('ï¼š');
                            if (firstColon > -1) lastEnding.text = line.substring(firstColon + 1).trim().replace(/\\n/g, '\n');
                        } else if (line.startsWith('æ¡ä»¶:')) {
                            const condStr = line.substring(3).trim().replace(/ï¼š/g, ':');
                            const match = condStr.match(/^(\S+)\s*(>=|<=|!=|>|<|=|has)\s*(.*)$/);
                            if (match) {
                                const cond = { attr: match[1], op: match[2], val: match[3] };
                                if (cond.attr !== 'å¤©èµ‹') cond.val = parseFloat(cond.val) || 0;
                                if (!lastEnding.conditions) lastEnding.conditions = [];
                                lastEnding.conditions.push(cond);
                            }
                        }
                        continue;
                    }

                    if (lastEvent && raw.startsWith('  ')) {
                        if (line.startsWith('once:')) {
                            lastEvent.once = line.split(':')[1].trim() === 'true';
                        } else if (line.startsWith('æ¦‚ç‡:')) {
                            const probStr = line.split(':')[1].replace(/ï¼š/g, ':').trim();
                            lastEvent.prob = parseFloat(probStr) || 100;
                        } else if (line.startsWith('æ¡ä»¶:')) {
                            const condStr = line.substring(3).trim();
                            const match = condStr.match(/^(\S+)\s*(>=|<=|!=|>|<|=|has)\s*(.*)$/);
                            if (match) {
                                if (!lastEvent.conditions) lastEvent.conditions = [];
                                const cond = { attr: match[1], op: match[2], val: match[3].trim() };
                                if (cond.op !== 'has') cond.val = parseFloat(cond.val) || 0;
                                lastEvent.conditions.push(cond);
                            }
                        } else if (line.startsWith('é€‰é¡¹:') || line.startsWith('é€‰é¡¹ï¼š')) {
                            console.log('[Parser] Found Choice line:', line);
                            const parts = line.substring(3).replace(/ï½œ/g, '|').split('|').map(s => s.trim());
                            console.log('[Parser] Split parts:', parts);
                            if (parts.length >= 1) {
                                const chEffect = {};
                                if (parts[1]) {
                                    parts[1].replace(/ï¼Œ/g, ',').split(',').forEach(pair => {
                                        const [k, v] = pair.replace(/ï¼š/g, ':').split(':').map(s => s.trim());
                                        if (k && v !== undefined) chEffect[k] = parseFloat(v) || 0;
                                    });
                                }
                                console.log('[Parser] Choice Effect:', chEffect);
                                const nextEventId = parts[2] ? parts[2].trim() : null;
                                if (!lastEvent.choices) lastEvent.choices = [];
                                lastEvent.choices.push({ text: parts[0], effect: chEffect, nextEventId });
                            }
                        }
                        continue;
                        continue;
                    }
                }

                if (data.worlds.length === 0 && data.events.length === 0 && data.talents.length === 0) {
                    alert('æœªèƒ½è§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥é…ç½®è¡¨æ ¼å¼ï¼');
                    return;
                }

                if (confirm(`è§£æå®Œæˆï¼\nä¸–ç•Œ: ${data.worlds.length}\nå¤©èµ‹: ${data.talents.length}\näº‹ä»¶: ${data.events.length}\nç»“å±€: ${(data.endings || []).length}\n\næ˜¯å¦å¯¼å…¥ï¼Ÿï¼ˆå°†è¦†ç›–å½“å‰æ•°æ®ï¼‰`)) {
                    this.data = data;
                    this.render();
                    alert('é…ç½®è¡¨å¯¼å…¥æˆåŠŸï¼');
                }
            },

            generateStandalone() {
                // Check for unsaved ending rules
                const hasUnsavedRules = Object.values(this.tempEndingRules || {}).some(r => r.right || r.endingId);
                if (hasUnsavedRules) {
                    if (!confirm('æ£€æµ‹åˆ°æ‚¨æœ‰æœªä¿å­˜çš„ç»“å±€è§¦å‘è§„åˆ™ï¼ˆå·²å¡«å†™ä½†æœªç‚¹å‡»æ·»åŠ æŒ‰é’®ï¼‰ã€‚\næ˜¯å¦å¿½ç•¥è¿™äº›è§„åˆ™å¹¶ç»§ç»­å¯¼å‡ºï¼Ÿ')) {
                        return;
                    }
                }

                // Read index.html from same directory via fetch, fallback to embedded template
                const config = JSON.stringify(this.data, null, 4);
                const newConfig = `let GAME_DATA = ${config}; `;

                // Try to fetch game.html from same directory
                fetch('game.html')
                    .then(r => { if (!r.ok) throw new Error('fetch failed'); return r.text(); })
                    .then(html => {
                        const regex = /let GAME_DATA = \{[\s\S]*?\};/;
                        if (!regex.test(html)) {
                            alert('æœªåœ¨ game.html ä¸­æ‰¾åˆ° GAME_DATAï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ­£ç¡®ã€‚');
                            return;
                        }
                        const result = html.replace(regex, newConfig);
                        this._downloadHtml(result);
                    })
                    .catch(() => {
                        // Fallback: ask user to upload
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.html';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                let html = ev.target.result;
                                const regex = /let GAME_DATA = \{[\s\S]*?\};/;
                                if (!regex.test(html)) {
                                    alert('æœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° GAME_DATAã€‚');
                                    return;
                                }
                                const result = html.replace(regex, newConfig);
                                this._downloadHtml(result);
                            };
                            reader.readAsText(file);
                        };
                        input.click();
                    });
            },

            _downloadHtml(htmlContent) {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'game.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            importFromFile() {
                const fileInput = document.getElementById('import-file');
                if (!fileInput.files.length) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª JSON æ–‡ä»¶ã€‚');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.data = JSON.parse(e.target.result);
                        this.currentView = 'worlds';
                        this.selectedId = null;
                        this.render();
                        alert('å¯¼å…¥æˆåŠŸ!');
                    } catch (err) {
                        alert('æ— æ•ˆçš„ JSON æ–‡ä»¶');
                    }
                };
                reader.readAsText(fileInput.files[0]);
            },

            updateItem(key, val) {
                let list = this.currentView === 'timeline' ? this.data.events : this.getList(this.currentView);
                const item = list.find(x => x.id === this.selectedId);
                if (item) {
                    item[key] = val;
                    this.render();
                }
            },

            // Save data silently (no re-render) â€” used by oninput on text fields
            updateItemSilent(key, val) {
                let list = this.currentView === 'timeline' ? this.data.events : this.getList(this.currentView);
                const item = list.find(x => x.id === this.selectedId);
                if (item) {
                    item[key] = val;
                }
            },

            updateJSONItem(key, valStr) {
                try {
                    const val = JSON.parse(valStr);
                    this.updateItem(key, val);
                } catch (e) { }
            },

            getList(view) {
                if (view === 'worlds') return this.data.worlds;
                if (view === 'talents') return this.data.talents;
                if (view === 'events') {
                    // Optimized Event List: Sorted by World -> Age
                    return this.data.events.sort((a, b) => {
                        if (a.worldId !== b.worldId) return a.worldId.localeCompare(b.worldId);
                        return a.minAge - b.minAge;
                    });
                }
                if (view === 'endings') return this.data.endings;
                return [];
            },

            copyToClipboard() {
                const text = JSON.stringify(this.data, null, 2);
                navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶!'));
            },

            importFromArea() {
                try {
                    this.data = JSON.parse(document.getElementById('io-area').value);
                    this.currentView = 'worlds';
                    this.selectedId = null;
                    this.render();
                    alert('å¯¼å…¥æˆåŠŸ!');
                } catch (e) { alert('æ— æ•ˆçš„ JSON'); }
            },

            // --- Visual Condition Editor ---
            renderConditionEditor(container, item) {
                // Convert old string condition to array format if needed
                if (typeof item.condition === 'string' && item.condition.trim()) {
                    // Try to parse old format like "æ ¹éª¨ > 5"
                    const match = item.condition.match(/^(\S+)\s*(>=|<=|!=|>|<|=)\s*(\S+)$/);
                    if (match) {
                        item.conditions = [{ attr: match[1], op: match[2], val: parseFloat(match[3]) || 0 }];
                    }
                    delete item.condition;
                } else if (typeof item.condition === 'string') {
                    delete item.condition;
                }

                const conditions = item.conditions || [];
                const worldId = item.worldId;
                const world = this.data.worlds.find(w => w.id === worldId);

                // Build attribute + talent lists
                let attrOptions = [];
                if (world) {
                    attrOptions = (world.uniqueAttributes || []).map(a => ({ value: a, label: a }));
                } else {
                    attrOptions = [{ value: 'è¯·å…ˆé€‰æ‹©ä¸–ç•Œ', label: 'è¯·å…ˆé€‰æ‹©ä¸–ç•Œ' }];
                }
                const worldTalents = this.data.talents.filter(t => t.worldId === worldId || !worldId);
                const talentIds = new Set(worldTalents.map(t => t.id));

                const operators = ['>', '<', '=', '>=', '<=', '!='];

                const section = document.createElement('div');
                section.className = 'form-group';
                let html = `<label>è§¦å‘æ¡ä»¶ (Conditions) â€” å…¨éƒ¨æ»¡è¶³æ—¶è§¦å‘</label>
                    <div style="background:#333; padding:8px; border:1px solid #555; border-radius:4px;">`;

                conditions.forEach((cond, idx) => {
                    const isTalent = talentIds.has(cond.attr) || cond.op === 'has';

                    html += `
                    <div class="flex-row" style="margin-bottom:5px; gap:5px;">
                        <select style="flex:2;" onchange="app.updateCondition('${item.id}', ${idx}, 'attr', this.value)">
                            <optgroup label="å±æ€§ (Attributes)">
                                ${attrOptions.map(a => `<option value="${a.value}" ${a.value === cond.attr ? 'selected' : ''}>${a.label}</option>`).join('')}
                            </optgroup>
                            <optgroup label="å¤©èµ‹ (Talents) â€” æ‹¥æœ‰å³è§¦å‘">
                                ${worldTalents.map(t => `<option value="${t.id}" ${t.id === cond.attr ? 'selected' : ''}>${t.name}</option>`).join('')}
                            </optgroup>
                        </select>`;

                    if (isTalent) {
                        // Talent: no operator/value, just a badge
                        html += `
                        <span style="color:#4caf50; font-size:0.85em; white-space:nowrap; padding:4px 8px; background:#1b5e20; border-radius:3px;">âœ“ æ‹¥æœ‰å³è§¦å‘</span>`;
                    } else {
                        // Attribute: operator + value
                        html += `
                        <select style="width:60px;" onchange="app.updateCondition('${item.id}', ${idx}, 'op', this.value)">
                            ${operators.map(o => `<option value="${o}" ${o === cond.op ? 'selected' : ''}>${o}</option>`).join('')}
                        </select>
                        <input type="number" value="${cond.val || 0}" style="width:70px;"
                            onchange="app.updateCondition('${item.id}', ${idx}, 'val', parseFloat(this.value))">`;
                    }

                    html += `
                        <button class="btn btn-danger" style="padding:2px 6px;"
                            onclick="app.removeCondition('${item.id}', ${idx})">Ã—</button>
                    </div>`;
                });

                html += `
                    <button class="btn btn-success" style="width:100%; margin-top:5px; padding:4px;"
                        onclick="app.addCondition('${item.id}')">+ æ·»åŠ æ¡ä»¶</button>
                    </div>`;

                section.innerHTML = html;
                container.appendChild(section);
            },

            addCondition(itemId) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;
                if (this.currentView === 'endings') list = this.data.endings;
                const item = list.find(x => x.id === itemId);
                if (!item) return;
                if (!item.conditions) item.conditions = [];

                // Default to first available attribute
                const world = this.data.worlds.find(w => w.id === item.worldId);
                let defaultAttr = 'æ¶å';
                if (world && world.uniqueAttributes.length > 0) {
                    defaultAttr = world.uniqueAttributes[0];
                }

                item.conditions.push({ attr: defaultAttr, op: '>', val: 0 });
                this.render();
            },

            removeCondition(itemId, idx) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;
                if (this.currentView === 'endings') list = this.data.endings;
                const item = list.find(x => x.id === itemId);
                if (!item || !item.conditions) return;
                item.conditions.splice(idx, 1);
                if (item.conditions.length === 0) delete item.conditions;
                this.render();
            },

            updateCondition(itemId, idx, field, value) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;
                if (this.currentView === 'endings') list = this.data.endings;
                const item = list.find(x => x.id === itemId);
                if (!item || !item.conditions || !item.conditions[idx]) return;
                item.conditions[idx][field] = value;

                if (field === 'attr') {
                    // Check if new value is a talent ID
                    const worldId = item.worldId;
                    const worldTalents = this.data.talents.filter(t => t.worldId === worldId || !worldId);
                    const isTalent = worldTalents.some(t => t.id === value);

                    if (isTalent) {
                        item.conditions[idx].op = 'has';
                        item.conditions[idx].val = '';
                    } else if (item.conditions[idx].op === 'has') {
                        item.conditions[idx].op = '>';
                        item.conditions[idx].val = 0;
                    }
                    this.render();
                }
            },

            // --- Visual Choice Editor & Methods ---
            renderChoiceEditor(container, item) {
                const choices = item.choices || [];
                const worldId = item.worldId;
                const world = this.data.worlds.find(w => w.id === worldId);

                // Attributes for dropdown
                let availableAttrs = [];
                if (world) {
                    availableAttrs = [...world.uniqueAttributes];
                } else {
                    availableAttrs = ['è¯·å…ˆé€‰æ‹©ä¸–ç•Œ'];
                }

                let html = '<div style="background:#222; padding:10px; border-radius:4px; border:1px solid #444;">';

                if (choices.length === 0) {
                    html += '<div style="color:#666; font-size:0.9em; margin-bottom:5px;">æ— é€‰é¡¹</div>';
                }

                choices.forEach((choice, idx) => {
                    const eff = choice.effect || {};
                    html += `
                    <div style="border:1px solid #444; padding:5px; margin-bottom:5px; background:#2a2a2a;">
                        <div class="flex-row" style="margin-bottom:5px;">
                            <span style="font-weight:bold; color:#aaa;">#${idx + 1}</span>
                            <input type="text" value="${choice.text || ''}" placeholder="é€‰é¡¹æè¿°" 
                                style="flex:1;" 
                                oninput="app.updateChoice('${item.id}', ${idx}, 'text', this.value)">
                            <button class="btn btn-danger" style="padding:2px 6px;" 
                                onclick="app.removeChoice('${item.id}', ${idx})">x</button>
                        </div>
                        <div class="flex-row" style="margin-bottom:5px;">
                            <label style="width:60px; color:#888; font-size:0.8em;">åç»­äº‹ä»¶:</label>
                            <input type="text" value="${choice.nextEventId || ''}" placeholder="äº‹ä»¶ID (å¯é€‰)" 
                                style="flex:1; font-family:monospace; font-size:0.9em;" 
                                oninput="app.updateChoice('${item.id}', ${idx}, 'nextEventId', this.value)">
                        </div>
                        <!-- Choice Effect -->
                        <div style="padding-left:20px; font-size:0.9em;">
                            <div style="color:#888; margin-bottom:2px;">æ•ˆæœ:</div>
                            ${Object.entries(eff).map(([effKey, effVal]) => `
                                <div class="flex-row" style="margin-bottom:2px;">
                                    <span style="width:60px; color:#aaa;">${effKey}</span>
                                    <input type="number" value="${effVal}" style="width:60px;"
                                        onchange="app.updateChoiceEffect('${item.id}', ${idx}, '${effKey}', parseFloat(this.value))">
                                    <button class="btn btn-danger" style="padding:0px 4px; font-size:0.8em;"
                                        onclick="app.removeChoiceEffect('${item.id}', ${idx}, '${effKey}')">x</button>
                                </div>
                            `).join('')}
                            <!-- Add Choice Effect -->
                             <div class="flex-row" style="margin-top:5px;">
                                <select id="new-ch-attr-${item.id}-${idx}" style="flex:1;">
                                    ${availableAttrs.map(a => `<option value="${a}">${a}</option>`).join('')}
                                </select>
                                <input type="number" id="new-ch-val-${item.id}-${idx}" placeholder="0" style="width:50px;">
                                <button class="btn btn-success" style="padding:2px 6px;"
                                    onclick="app.addChoiceEffect('${item.id}', ${idx})">+</button>
                            </div>
                        </div>
                    </div>
            `;
                });

                html += `
            <button class="btn btn-success" style="width:100%; margin-top:5px;"
                onclick="app.addChoice('${item.id}')">+ æ·»åŠ é€‰é¡¹</button>
            `;

                html += '</div>';

                const wrapper = document.createElement('div');
                wrapper.className = 'form-group';
                wrapper.innerHTML = `<label>é€‰é¡¹ (Choices)</label>${html}`;
                container.appendChild(wrapper);
            },

            // --- Choice Management Methods ---
            addChoice(itemId) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                // Fallback for timeline view
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item) return;
                if (!item.choices) item.choices = [];
                item.choices.push({ text: 'æ–°é€‰é¡¹', effect: {} });
                this.render();
            },

            removeChoice(itemId, idx) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                // Fallback
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item || !item.choices) return;
                item.choices.splice(idx, 1);
                this.render();
            },

            updateChoice(itemId, idx, field, value) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item || !item.choices || !item.choices[idx]) return;
                item.choices[idx][field] = value;
            },

            addChoiceEffect(itemId, idx) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item || !item.choices || !item.choices[idx]) return;

                const attr = document.getElementById(`new- ch - attr - ${itemId} -${idx} `).value;
                const val = parseFloat(document.getElementById(`new- ch - val - ${itemId} -${idx}`).value) || 0;

                if (!item.choices[idx].effect) item.choices[idx].effect = {};
                item.choices[idx].effect[attr] = val;
                this.render();
            },

            removeChoiceEffect(itemId, idx, key) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item || !item.choices || !item.choices[idx] || !item.choices[idx].effect) return;
                delete item.choices[idx].effect[key];
                this.render();
            },

            updateChoiceEffect(itemId, idx, key, val) {
                let list = this.currentView === 'events' ? this.data.events : this.getList(this.currentView);
                if (this.currentView === 'timeline') list = this.data.events;

                const item = list.find(x => x.id === itemId);
                if (!item || !item.choices || !item.choices[idx] || !item.choices[idx].effect) return;
                item.choices[idx].effect[key] = val;
            }
        };

        app.init();
    </script>
</body>

</html>